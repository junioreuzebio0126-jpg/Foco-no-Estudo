<!DOCTYPE html>
<html lang="pt-br" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Gerenciador de estudos e pastas de questões com IA.">
    <title>Minhas Pastas | Foco no Estudo</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['Roboto', 'monospace'],
                    },
                    colors: {
                        tecBlue: '#007bc0',
                        tecBlueDark: '#005f9e',
                        tecBg: '#f3f5f7',
                        tecText: '#333333',
                        tecBorder: '#e0e0e0',
                        tecGreen: '#28a745',
                        tecGray: '#6c757d',
                        geminiPurple: '#8E24AA',
                        geminiLight: '#F3E5F5',
                        pomoRed: '#E53935',
                        pomoBlue: '#1E88E5',
                        pomoBg: '#FFEBEE',
                        darkBg: '#0f172a',
                        darkCard: '#1e293b',
                        darkBorder: '#334155'
                    },
                    boxShadow: {
                        'dashboard': '0 2px 4px rgba(0,0,0,0.05)',
                    }
                }
            }
        }
    </script>

    <style>
        body { transition: background-color 0.3s ease, color 0.3s ease; }
        .folder-card, .modal-content, header, footer { transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease; }

        .folder-card {
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }
        
        .status-bar {
            position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
            background-color: #e0e0e0; transition: background-color 0.2s;
        }
        .folder-card:hover .status-bar { background-color: #007bc0; }
        .dark .status-bar { background-color: #475569; }
        .dark .folder-card:hover .status-bar { background-color: #3b82f6; }

        #modal-overlay, #add-subject-modal-overlay, #confirm-modal-overlay, #add-subtopic-modal-overlay, #stats-modal-overlay, #pomo-modal-overlay, #teoria-modal-overlay, #analytics-modal { backdrop-filter: blur(2px); }
        
        .ai-response strong { font-weight: 700; color: inherit; } 
        .ai-response ul { list-style-type: disc; padding-left: 1.2rem; margin-bottom: 0.5rem; }
        .ai-response li { margin-bottom: 0.25rem; }
        .ai-response p { margin-bottom: 0.5rem; }
        .ai-response { font-family: 'Inter', sans-serif; line-height: 1.5; font-size: 0.95rem; }
        
        .progress-bar-bg { border-radius: 9999px; overflow: hidden; }
        .progress-bar-fill { background-color: #007bc0; height: 100%; transition: width 0.5s ease-out; }
        .dark .progress-bar-fill { background-color: #3b82f6; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast { animation: slideIn 0.3s ease-out forwards; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        @keyframes growUp { from { height: 0; } to { height: var(--h); } }
        .bar-animate { animation: growUp 1s ease-out forwards; }
    </style>
</head>
<body class="bg-[#f3f5f7] dark:bg-slate-900 text-tecText dark:text-slate-200 flex flex-col min-h-screen relative selection:bg-tecBlue selection:text-white">

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="fixed top-5 right-5 z-[70] flex flex-col gap-2 pointer-events-none"></div>

    <!-- HEADER -->
    <header class="bg-white dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 sticky top-0 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-tecBlue dark:bg-blue-600 rounded flex items-center justify-center text-white font-bold text-lg shadow-sm">F</div>
                <h1 class="text-xl font-semibold text-gray-800 dark:text-white tracking-tight">Foco no Estudo</h1>
            </div>
            
            <div class="flex items-center gap-2 md:gap-4">
                <button onclick="toggleDarkMode()" class="p-2 text-gray-500 hover:text-tecBlue dark:text-slate-400 dark:hover:text-blue-400 transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-slate-700" title="Alternar Modo Noturno">
                    <svg id="icon-sun" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="icon-moon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 block dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
                <button onclick="openTeoriaModal()" class="flex items-center gap-2 text-sm font-medium text-gray-600 dark:text-slate-300 hover:text-tecBlue dark:hover:text-blue-400 transition-colors bg-gray-50 dark:bg-slate-700 px-3 py-1.5 rounded-full border border-gray-200 dark:border-slate-600 hover:border-tecBlue dark:hover:border-blue-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                    Teoria
                </button>
                <button onclick="openStatsModal()" class="flex items-center gap-2 text-sm font-medium text-gray-600 dark:text-slate-300 hover:text-tecBlue dark:hover:text-blue-400 transition-colors bg-gray-50 dark:bg-slate-700 px-3 py-1.5 rounded-full border border-gray-200 dark:border-slate-600 hover:border-tecBlue dark:hover:border-blue-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 01-2-2z" /></svg>
                    Estatísticas
                </button>
                <button onclick="analyzePerformance()" class="hidden md:flex items-center gap-2 text-sm font-medium text-geminiPurple hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300 transition-colors bg-purple-50 dark:bg-purple-900/20 px-3 py-1.5 rounded-full border border-purple-100 dark:border-purple-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                    Mentor IA
                </button>
                <div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-slate-700 border-2 border-white dark:border-slate-600 shadow-sm overflow-hidden">
                    <svg class="w-full h-full text-gray-400 dark:text-slate-500 p-1" fill="currentColor" viewBox="0 0 24 24"><path d="M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
            <div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Minhas Pastas</h2>
                <p class="text-sm text-gray-500 dark:text-slate-400 mt-1">Gerencie seus cadernos, subtópicos e simulados IA.</p>
            </div>
            <button onclick="openAddSubjectModal()" class="bg-tecBlue hover:bg-tecBlueDark dark:bg-blue-600 dark:hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors shadow-sm flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                Nova Matéria
            </button>
        </div>
        <div id="folders-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </main>

    <!-- FOOTER -->
    <footer class="bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700 mt-auto py-8">
        <div class="max-w-7xl mx-auto px-4 text-center text-sm text-gray-500 dark:text-slate-400">
            <p>&copy; 2024 Foco no Estudo. Todos os direitos reservados.</p>
        </div>
    </footer>

    <!-- FAB POMODORO -->
    <button id="fab-pomo" onclick="openPomoModal()" class="fixed bottom-6 right-6 z-40 bg-pomoRed dark:bg-red-600 text-white p-4 rounded-full shadow-2xl hover:scale-105 transition-all focus:outline-none focus:ring-4 focus:ring-red-300 dark:focus:ring-red-900 group" title="Abrir Pomodoro">
        <svg id="fab-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 group-hover:rotate-12 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <span id="pomo-badge" class="absolute top-0 right-0 w-3 h-3 bg-green-400 border-2 border-white rounded-full hidden"></span>
    </button>

    <!-- MODAL POMODORO -->
    <div id="pomo-modal-overlay" class="fixed inset-0 bg-gray-900/30 dark:bg-black/60 hidden z-[80] flex items-end sm:items-center justify-center sm:justify-end p-4 sm:p-6 transition-opacity duration-300 backdrop-blur-sm" onclick="closePomoModal(event)">
        <div id="pomo-modal-content" class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full sm:w-80 transform scale-95 opacity-0 transition-all duration-300 p-6 relative flex flex-col gap-4 border border-gray-100 dark:border-slate-700">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white flex items-center gap-2">
                    <span id="pomo-icon-modal" class="text-pomoRed dark:text-red-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg></span>
                    <span id="pomo-title-text">Pomodoro (Foco)</span>
                </h3>
                <button onclick="closePomoModal()" class="text-gray-400 dark:text-slate-500 hover:text-gray-600 dark:hover:text-slate-300 rounded-full p-1 hover:bg-gray-100 dark:hover:bg-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="bg-gray-50 dark:bg-slate-700 rounded-xl p-4 text-center border border-gray-100 dark:border-slate-600">
                <div class="text-5xl font-mono font-bold text-gray-800 dark:text-white tracking-wider mb-2 transition-colors duration-300" id="pomodoro-display-modal">25:00</div>
                <div class="flex justify-center gap-2">
                    <button id="btn-pomo-main-modal" onclick="togglePomodoro()" class="bg-pomoRed dark:bg-red-600 text-white px-6 py-2 rounded-lg hover:brightness-90 transition-all font-medium shadow-sm w-full">Iniciar</button>
                    <button onclick="resetPomodoro()" class="bg-white dark:bg-slate-600 border border-gray-300 dark:border-slate-500 text-gray-600 dark:text-slate-200 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-500 transition-colors" title="Reiniciar">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                    </button>
                </div>
            </div>
            <div class="space-y-3">
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="block text-xs font-semibold text-gray-500 dark:text-slate-400 mb-1">Foco (min)</label>
                        <input type="number" id="pomo-focus-time" value="25" min="1" max="120" onchange="updatePomoSettings()" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg px-3 py-1.5 text-sm text-center focus:ring-2 focus:ring-pomoRed focus:border-pomoRed outline-none">
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-semibold text-gray-500 dark:text-slate-400 mb-1">Descanso (min)</label>
                        <input type="number" id="pomo-break-time" value="5" min="1" max="60" onchange="updatePomoSettings()" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg px-3 py-1.5 text-sm text-center focus:ring-2 focus:ring-pomoBlue focus:border-pomoBlue outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 dark:text-slate-400 mb-1">Som do Alarme</label>
                    <select id="pomo-alarm-type" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg px-3 py-1.5 text-sm bg-white dark:bg-slate-700 focus:ring-2 focus:ring-pomoRed outline-none cursor-pointer">
                        <option value="beep">Bip Simples</option>
                        <option value="digital">Relógio Digital</option>
                        <option value="bell">Sino Suave</option>
                        <option value="bird">Pássaro (Assobio)</option>
                        <option value="laser">Laser Futurológico</option>
                        <option value="magic">Mágica (Sucesso)</option>
                    </select>
                </div>
            </div>
            <p class="text-[10px] text-gray-400 dark:text-slate-500 text-center mt-2">O cronômetro alterna automaticamente entre Foco e Descanso.</p>
        </div>
    </div>

    <!-- MODAL TEORIA -->
    <div id="teoria-modal-overlay" class="fixed inset-0 bg-gray-900/40 dark:bg-black/60 hidden z-[75] flex items-center justify-center p-4 opacity-0 transition-opacity duration-300" onclick="closeTeoriaModal(event)">
        <div id="teoria-modal-content" class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl max-w-3xl w-full max-h-[85vh] transform scale-95 opacity-0 transition-all duration-300 flex flex-col relative overflow-hidden">
            <div class="bg-white dark:bg-slate-800 border-b border-gray-100 dark:border-slate-700 px-8 py-5 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-50 dark:bg-slate-700 text-tecBlue dark:text-blue-400 p-2 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white">Teoria</h3>
                        <p class="text-xs text-gray-500 dark:text-slate-400">Fundamentos essenciais para seus estudos.</p>
                    </div>
                </div>
                <button onclick="closeTeoriaModal()" class="text-gray-400 dark:text-slate-500 hover:text-gray-600 dark:hover:text-slate-300 rounded-full p-2 hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="p-8 overflow-y-auto bg-white dark:bg-slate-800 flex-grow text-gray-700 dark:text-slate-300">
                <div class="prose dark:prose-invert max-w-none">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">Fundamentos</h2>
                    <p class="mb-4">Esta seção reúne os principais conceitos teóricos que fundamentam as estatísticas apresentadas. Aqui estão alguns conceitos essenciais para entender os dados apresentados.</p>
                    <ul class="list-disc pl-5 space-y-3">
                        <li><a href="#" class="text-tecBlue dark:text-blue-400 hover:underline hover:text-blue-600 transition-colors">Teoria 1 – Conceito base</a></li>
                        <li><a href="#" class="text-tecBlue dark:text-blue-400 hover:underline hover:text-blue-600 transition-colors">Teoria 2 – Modelo explicativo</a></li>
                        <li><a href="#" class="text-tecBlue dark:text-blue-400 hover:underline hover:text-blue-600 transition-colors">Teoria 3 – Abordagem estatística</a></li>
                        <li><a href="#" class="text-tecBlue dark:text-blue-400 hover:underline hover:text-blue-600 transition-colors">Teoria 4 – Análise de dados</a></li>
                        <li><a href="#" class="text-tecBlue dark:text-blue-400 hover:underline hover:text-blue-600 transition-colors">Teoria 5 – Referência complementar</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL ESTATÍSTICAS -->
    <div id="stats-modal-overlay" class="fixed inset-0 bg-gray-900/40 dark:bg-black/60 hidden z-[70] flex items-center justify-center p-4 opacity-0 transition-opacity duration-300" onclick="closeStatsModal(event)">
        <div id="stats-modal-content" class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl max-w-5xl w-full h-[85vh] transform scale-95 opacity-0 transition-all duration-300 flex flex-col relative overflow-hidden">
            <!-- Header -->
            <div class="bg-white dark:bg-slate-800 border-b border-gray-100 dark:border-slate-700 px-8 py-5 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-50 dark:bg-slate-700 text-tecBlue dark:text-blue-400 p-2 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 01-2-2z" /></svg>
                    </div>
                    <div>
                        <!-- Título alterado de "Dashboard de Desempenho" para "Estatísticas" -->
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white">Estatísticas</h3>
                        <p class="text-xs text-gray-500 dark:text-slate-400">Visão geral do seu progresso.</p>
                    </div>
                </div>
                
                <!-- Date Picker & Close -->
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <input type="date" id="stats-date-filter" onchange="renderStats()" class="border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg px-3 py-1.5 text-sm text-gray-600 focus:outline-none focus:border-tecBlue focus:ring-1 focus:ring-tecBlue shadow-sm cursor-pointer">
                    </div>
                    <button onclick="closeStatsModal()" class="text-gray-400 dark:text-slate-500 hover:text-gray-600 dark:hover:text-slate-300 rounded-full p-2 hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </div>

            <!-- Content Scrollable -->
            <div class="p-8 overflow-y-auto bg-gray-50 dark:bg-slate-900/50 flex-grow" id="stats-content">
                <!-- Conteúdo será injetado via JS -->
            </div>
        </div>
    </div>

    <!-- Hidden Modals (Add Subject, Subtopic, Confirm) -->
    <div id="add-subject-modal-overlay" class="fixed inset-0 bg-gray-900/40 dark:bg-black/60 hidden z-50 flex items-center justify-center p-4 opacity-0 transition-opacity duration-300" onclick="closeAddSubjectModal(event)"><div id="add-subject-modal-content" class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-md w-full transform scale-95 opacity-0 transition-all duration-300 p-0 relative overflow-hidden"><div class="bg-tecBg dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 px-6 py-4 flex justify-between items-center"><h3 class="text-lg font-bold text-gray-800 dark:text-white">Nova Matéria</h3><button onclick="closeAddSubjectModal()" class="text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div class="p-6"><div class="mb-4"><label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Nome da Matéria</label><input type="text" id="new-subject-name" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-tecBlue" placeholder="Ex: Direito Administrativo"></div><div class="mb-6"><label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Descrição Curta</label><input type="text" id="new-subject-desc" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-tecBlue" placeholder="Ex: Atos Administrativos e Poderes"></div><div class="flex justify-end gap-3"><button onclick="closeAddSubjectModal()" class="px-4 py-2 text-gray-600 dark:text-slate-400 hover:bg-gray-100 dark:hover:bg-slate-700 rounded">Cancelar</button><button onclick="saveNewSubject()" class="px-4 py-2 bg-tecBlue text-white hover:bg-tecBlueDark rounded font-medium">Criar Pasta</button></div></div></div></div>
    <div id="add-subtopic-modal-overlay" class="fixed inset-0 bg-gray-900/40 dark:bg-black/60 hidden z-[55] flex items-center justify-center p-4 opacity-0 transition-opacity duration-300" onclick="closeAddSubtopicModal(event)"><div id="add-subtopic-modal-content" class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-sm w-full transform scale-95 opacity-0 transition-all duration-300 p-0 relative overflow-hidden"><div class="bg-tecBg dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 px-6 py-4 flex justify-between items-center"><h3 class="text-lg font-bold text-gray-800 dark:text-white">Novo Subtópico</h3><button onclick="closeAddSubtopicModal()" class="text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div class="p-6"><div class="mb-4"><label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Nome do Subtópico</label><input type="text" id="new-subtopic-name" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-tecBlue" placeholder="Ex: Crase, Verbos, Atos..."></div><div class="flex justify-end gap-3"><button onclick="closeAddSubtopicModal()" class="px-4 py-2 text-gray-600 dark:text-slate-400 hover:bg-gray-100 dark:hover:bg-slate-700 rounded">Cancelar</button><button onclick="saveNewSubtopic()" class="px-4 py-2 bg-tecBlue text-white hover:bg-tecBlueDark rounded font-medium">Adicionar</button></div></div></div></div>
    <div id="confirm-modal-overlay" class="fixed inset-0 bg-gray-900/40 dark:bg-black/60 hidden z-[60] flex items-center justify-center p-4 opacity-0 transition-opacity duration-300" onclick="closeConfirmModal(event)"><div id="confirm-modal-content" class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-sm w-full transform scale-95 opacity-0 transition-all duration-300 p-6 text-center"><div class="w-12 h-12 rounded-full bg-red-100 dark:bg-red-900/30 text-red-500 flex items-center justify-center mx-auto mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg></div><h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2">Tem certeza?</h3><p id="confirm-modal-msg" class="text-sm text-gray-600 dark:text-slate-400 mb-6">Esta ação não poderá ser desfeita.</p><div class="flex gap-3 justify-center"><button onclick="closeConfirmModal()" class="px-4 py-2 border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-slate-300 rounded hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors">Cancelar</button><button id="confirm-modal-btn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors">Confirmar</button></div></div></div>

    <script>
        const apiKey = ""; 
        
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            renderGrid();
            if (!document.getElementById('stats-modal-overlay').classList.contains('hidden')) renderStats();
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        
        function getDateString(daysOffset = 0) {
            const d = new Date();
            d.setDate(d.getDate() - daysOffset);
            return d.toISOString().split('T')[0];
        }

        let subjects = [
            { 
                id: 'sub_1', title: 'Direito Constitucional', iconColor: 'text-blue-600 dark:text-blue-400', bgColor: 'bg-blue-100 dark:bg-blue-900/30', statusBarColor: 'bg-blue-500', hoverText: 'group-hover:text-tecBlue dark:group-hover:text-blue-400', 
                totalQuestions: 1240, correctCount: 967, goal: 50, progress: 15, todayCorrect: 12,
                subtopics: [],
                history: [
                    { date: getDateString(1), total: 40, correct: 35 },
                    { date: getDateString(2), total: 20, correct: 15 },
                    { date: getDateString(5), total: 60, correct: 50 }
                ]
            },
            { 
                id: 'sub_2', title: 'Português - FGV', iconColor: 'text-orange-600 dark:text-orange-400', bgColor: 'bg-orange-100 dark:bg-orange-900/30', statusBarColor: 'bg-orange-500', hoverText: 'group-hover:text-orange-600 dark:group-hover:text-orange-400', 
                totalQuestions: 850, correctCount: 527, goal: 30, progress: 0, todayCorrect: 0,
                subtopics: [{ id: 'st_1', title: 'Interpretação', totalQuestions: 500, correctCount: 300 }, { id: 'st_2', title: 'Crase', totalQuestions: 350, correctCount: 227 }],
                history: [
                    { date: getDateString(1), total: 30, correct: 15 },
                    { date: getDateString(3), total: 25, correct: 20 }
                ]
            },
            { 
                id: 'sub_3', title: 'Raciocínio Lógico', iconColor: 'text-purple-600 dark:text-purple-400', bgColor: 'bg-purple-100 dark:bg-purple-900/30', statusBarColor: 'bg-purple-500', hoverText: 'group-hover:text-purple-600 dark:group-hover:text-purple-400', 
                totalQuestions: 230, correctCount: 0, goal: 20, progress: 5, todayCorrect: 2,
                subtopics: [],
                history: []
            }
        ];

        let currentSubjectId = null;
        let pendingAction = null;
        let pomoTime = 25 * 60; 
        let pomoInterval = null;
        let pomoRunning = false;
        let pomoMode = 'focus'; 
        let audioContext = null;

        document.addEventListener('DOMContentLoaded', () => { 
            initTheme();
            renderGrid(); 
            document.getElementById('stats-date-filter').value = getDateString(0);
        });

        // --- TEORIA LOGIC ---
        function openTeoriaModal() {
            const modal = document.getElementById('teoria-modal-overlay');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.children[0].classList.remove('scale-95', 'opacity-0');
                modal.children[0].classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeTeoriaModal(event) {
             if (event && event.target !== document.getElementById('teoria-modal-overlay') && !event.target.closest('button')) return;
             const modal = document.getElementById('teoria-modal-overlay');
             modal.classList.add('opacity-0');
             modal.children[0].classList.remove('scale-100', 'opacity-100');
             modal.children[0].classList.add('scale-95', 'opacity-0');
             setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // --- STATS LOGIC ---
        function openStatsModal() {
            document.getElementById('stats-date-filter').value = getDateString(0);
            renderStats();
            const modal = document.getElementById('stats-modal-overlay');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.children[0].classList.remove('scale-95', 'opacity-0');
                modal.children[0].classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeStatsModal(event) {
            if (event && event.target !== document.getElementById('stats-modal-overlay') && !event.target.closest('button')) return;
            const modal = document.getElementById('stats-modal-overlay');
            modal.classList.add('opacity-0');
            modal.children[0].classList.remove('scale-100', 'opacity-100');
            modal.children[0].classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function renderStats() {
            const container = document.getElementById('stats-content');
            const selectedDate = document.getElementById('stats-date-filter').value;
            const today = getDateString(0);
            const isToday = selectedDate === today;

            let totalQ = 0;
            let totalC = 0;
            let todayQ = 0; 
            
            let displaySubjects = subjects.map(s => {
                let q = 0;
                let c = 0;
                if (isToday) {
                    q = s.progress;
                    c = s.todayCorrect || 0;
                } else {
                    const entry = s.history ? s.history.find(h => h.date === selectedDate) : null;
                    if (entry) {
                        q = entry.total;
                        c = entry.correct;
                    }
                }
                return { ...s, statQ: q, statC: c };
            });

            displaySubjects.forEach(s => {
                totalQ += s.statQ;
                totalC += s.statC;
                if(isToday) todayQ += s.progress;
            });
            
            let totalAcc = totalQ > 0 ? Math.round((totalC / totalQ) * 100) : 0;
            let totalErr = 100 - totalAcc;
            let totalAccColor = '#22c55e'; // Verde para acerto

            // --- PIE CHART (Gráfico de Pizza) ---
            // Usando conic-gradient para criar o gráfico de pizza.
            // Verde (acertos) e Vermelho (erros)
            const pieChart = `
                <div class="w-24 h-24 rounded-full shadow-inner relative flex items-center justify-center"
                     style="background: conic-gradient(${totalAccColor} ${totalAcc}%, #ef4444 0);">
                     <!-- Círculo branco interno opcional se quiser donut, removido para ser pizza sólida -->
                </div>
            `;

            if (totalQ === 0 && !isToday) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-gray-400 dark:text-slate-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                        </svg>
                        <p class="text-lg">Sem dados para <span class="font-bold text-gray-500 dark:text-slate-400">${selectedDate.split('-').reverse().join('/')}</span></p>
                        <p class="text-sm">Selecione outra data ou comece a praticar!</p>
                    </div>
                `;
                return;
            }

            let html = `
            <div class="mb-4">
                <span class="text-xs font-semibold uppercase tracking-wider text-gray-400 dark:text-slate-500">Resumo de:</span>
                <span class="text-lg font-bold text-gray-800 dark:text-white ml-1">${selectedDate === today ? 'Hoje' : selectedDate.split('-').reverse().join('/')}</span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-gray-100 dark:border-slate-600 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500 dark:text-slate-300 font-medium mb-1">Questões Hoje (Real)</p>
                        <p class="text-4xl font-bold text-tecBlue dark:text-blue-400">${isToday ? todayQ : totalQ}</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-50 dark:bg-slate-600 text-tecBlue dark:text-blue-400 rounded-xl flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-gray-100 dark:border-slate-600 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500 dark:text-slate-300 font-medium mb-1">Total Selecionado</p>
                        <p class="text-4xl font-bold text-gray-800 dark:text-white">${totalQ}</p>
                    </div>
                    <div class="w-12 h-12 bg-gray-100 dark:bg-slate-600 text-gray-600 dark:text-slate-300 rounded-xl flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-700 p-4 rounded-2xl border border-gray-100 dark:border-slate-600 shadow-sm flex items-center justify-between relative overflow-hidden">
                    <div class="z-10">
                        <p class="text-sm text-gray-500 dark:text-slate-300 font-medium mb-1">Taxa de Sucesso</p>
                        <div class="flex items-baseline gap-2">
                            <p class="text-4xl font-bold text-green-500">${totalAcc}%</p>
                            <span class="text-xs text-gray-400 dark:text-slate-400">Acertos</span>
                        </div>
                        <div class="flex items-baseline gap-2 mt-1">
                            <p class="text-xl font-bold text-red-500">${totalErr}%</p>
                            <span class="text-xs text-gray-400 dark:text-slate-400">Erros</span>
                        </div>
                    </div>
                    <div class="relative flex items-center justify-center p-2">
                       ${pieChart}
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border border-gray-100 dark:border-slate-600 shadow-sm">
                    <h4 class="text-lg font-bold text-gray-800 dark:text-white mb-6 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 dark:text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 01-2-2z" /></svg>
                        Comparativo de Precisão (Acertos vs Erros)
                    </h4>
                    
                    <div class="space-y-6">
                        ${displaySubjects.filter(s => s.statQ > 0).map(s => {
                            let acc = Math.round((s.statC / s.statQ) * 100);
                            let err = 100 - acc;
                            let errCount = s.statQ - s.statC;
                            
                            return `
                            <div>
                                <div class="flex justify-between text-sm font-medium mb-2">
                                    <span class="text-gray-700 dark:text-slate-200 w-1/3 truncate">${s.title}</span>
                                    <div class="flex gap-4">
                                        <span class="text-green-600 flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> ${acc}%</span>
                                        <span class="text-red-500 flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> ${err}%</span>
                                    </div>
                                </div>
                                <div class="w-full h-4 rounded-full overflow-hidden flex bg-gray-100 dark:bg-slate-600">
                                    <div class="bg-green-500 h-full bar-animate relative group" style="--h: 100%; width: ${acc}%">
                                        <div class="absolute bottom-full mb-1 left-1/2 -translate-x-1/2 bg-green-600 text-white text-[10px] px-1.5 py-0.5 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">${s.statC} Q</div>
                                    </div>
                                    <div class="bg-red-500 h-full bar-animate relative group" style="--h: 100%; width: ${err}%">
                                        <div class="absolute bottom-full mb-1 left-1/2 -translate-x-1/2 bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">${errCount} Q</div>
                                    </div>
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>

            <h4 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Tabela de Dados</h4>
            <div class="bg-white dark:bg-slate-700 rounded-xl border border-gray-200 dark:border-slate-600 overflow-hidden shadow-sm">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-slate-600">
                    <thead class="bg-gray-50 dark:bg-slate-600">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 dark:text-slate-300 uppercase tracking-wider">Matéria</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 dark:text-slate-300 uppercase tracking-wider">Questões</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-green-600 uppercase tracking-wider">Acertos</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-red-500 uppercase tracking-wider">Erros</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 dark:text-slate-300 uppercase tracking-wider">% Liq</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-slate-700 divide-y divide-gray-200 dark:divide-slate-600">`;

            displaySubjects.filter(s => s.statQ > 0).forEach(s => {
                let sAcc = Math.round((s.statC/s.statQ)*100);
                let sErrCount = s.statQ - s.statC;
                
                html += `
                <tr class="hover:bg-gray-50 dark:hover:bg-slate-600 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-800 dark:text-white">${s.title}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-slate-300 font-mono">${s.statQ}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-green-600 font-mono">${s.statC}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-red-500 font-mono">${sErrCount}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-700 dark:text-slate-200">${sAcc}%</td>
                </tr>`;
            });

            html += `</tbody></table></div>`;
            
            container.innerHTML = html;
        }

        // --- SHARED FUNCTIONS ---
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            let bgClass = 'bg-gray-800';
            if(type === 'error') bgClass = 'bg-red-600';
            if(type === 'success') bgClass = 'bg-green-600';
            toast.className = `toast ${bgClass} text-white text-sm px-4 py-2 rounded shadow-lg pointer-events-auto flex items-center gap-2`;
            toast.innerHTML = `<span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function renderGrid() {
            const grid = document.getElementById('folders-grid');
            grid.innerHTML = '';
            subjects.forEach(sub => {
                const pctGoal = sub.goal > 0 ? Math.min((sub.progress / sub.goal) * 100, 100) : 0;
                let accPct = 0;
                let accText = '--';
                let accColor = 'text-gray-400 dark:text-slate-500';
                
                if (sub.totalQuestions > 0) {
                    accPct = Math.round((sub.correctCount / sub.totalQuestions) * 100);
                    accText = accPct + '%';
                    if (accPct >= 80) accColor = 'text-green-600 dark:text-green-400'; 
                    else if (accPct >= 60) accColor = 'text-yellow-600 dark:text-yellow-400'; 
                    else accColor = 'text-red-500 dark:text-red-400';
                }
                const errors = sub.totalQuestions - sub.correctCount;
                
                // Extrair a cor base da classe bg-*-500 para usar na borda lateral
                const borderColorClass = sub.statusBarColor.replace('bg-', 'border-'); 

                const cardHTML = `
                <div onclick="openModal('${sub.id}')" class="group relative bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-slate-700 hover:border-gray-300 dark:hover:border-slate-600 shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer overflow-hidden flex flex-col h-full">
                    
                    <!-- Indicador Lateral Colorido -->
                    <div class="absolute left-0 top-0 bottom-0 w-1 ${sub.statusBarColor}"></div>

                    <!-- Botão Excluir (Discreto) -->
                    <button onclick="deleteFolderFromCard(event, '${sub.id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 p-1.5 rounded-md transition-all opacity-0 group-hover:opacity-100 z-20" title="Excluir Pasta">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>

                    <div class="p-4 pl-5 flex-grow">
                        <!-- Cabeçalho: Ícone e Título -->
                        <div class="flex items-start gap-3 mb-3">
                            <div class="${sub.iconColor} mt-0.5">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                                </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-semibold text-gray-800 dark:text-white text-base leading-tight truncate" title="${sub.title}">${sub.title}</h3>
                                <p class="text-xs text-gray-500 dark:text-slate-400 mt-1 truncate">${sub.desc || 'Matéria de estudo'}</p>
                            </div>
                        </div>

                        <!-- Métricas Detalhadas (Compactas) -->
                        <div class="grid grid-cols-4 gap-2 py-3 border-t border-gray-100 dark:border-slate-700/50 mt-2">
                            <div class="flex flex-col">
                                <span class="text-[10px] text-gray-400 uppercase tracking-wide">Total</span>
                                <span class="text-xs font-bold text-gray-700 dark:text-slate-300 font-mono">${sub.totalQuestions}</span>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-[10px] text-gray-400 uppercase tracking-wide">Acertos</span>
                                <span class="text-xs font-bold text-green-600 dark:text-green-500 font-mono">${sub.correctCount}</span>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-[10px] text-gray-400 uppercase tracking-wide">Erros</span>
                                <span class="text-xs font-bold text-red-500 dark:text-red-400 font-mono">${errors}</span>
                            </div>
                            <div class="flex flex-col text-right">
                                <span class="text-[10px] text-gray-400 uppercase tracking-wide">Aprov.</span>
                                <span class="text-xs font-bold ${accColor} font-mono">${accText}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Rodapé: Meta Diária -->
                    <div class="bg-gray-50 dark:bg-slate-700/30 px-4 py-2 flex items-center justify-between border-t border-gray-100 dark:border-slate-700/50">
                        <span class="text-[10px] font-medium text-gray-500 dark:text-slate-400 uppercase">Meta Diária</span>
                        <div class="flex items-center gap-2 w-1/2 justify-end">
                            <span class="text-[10px] font-semibold text-gray-700 dark:text-slate-300">${sub.progress}/${sub.goal}</span>
                            <div class="w-16 h-1.5 bg-gray-200 dark:bg-slate-600 rounded-full overflow-hidden">
                                <div class="h-full transition-all duration-500 ${pctGoal >= 100 ? 'bg-green-500' : sub.statusBarColor}" style="width: ${pctGoal}%"></div>
                            </div>
                        </div>
                    </div>
                </div>`;
                grid.innerHTML += cardHTML;
            });
        }

        // --- ALL PREVIOUS MODAL/LOGIC FUNCTIONS KEPT EXACTLY SAME ---
        function deleteFolderFromCard(event, id) { event.stopPropagation(); currentSubjectId = id; requestDeleteSubject(); }
        function openAddSubjectModal() { document.getElementById('new-subject-name').value = ''; document.getElementById('new-subject-desc').value = ''; document.getElementById('add-subject-modal-overlay').classList.remove('hidden'); setTimeout(() => { document.getElementById('add-subject-modal-overlay').classList.remove('opacity-0'); document.getElementById('add-subject-modal-content').classList.remove('scale-95', 'opacity-0'); document.getElementById('add-subject-modal-content').classList.add('scale-100', 'opacity-100'); }, 10); }
        function closeAddSubjectModal(event) { if (event && event.target !== document.getElementById('add-subject-modal-overlay')) return; document.getElementById('add-subject-modal-overlay').classList.add('opacity-0'); document.getElementById('add-subject-modal-content').classList.remove('scale-100', 'opacity-100'); document.getElementById('add-subject-modal-content').classList.add('scale-95', 'opacity-0'); setTimeout(() => { document.getElementById('add-subject-modal-overlay').classList.add('hidden'); }, 300); }
        function saveNewSubject() { const name = document.getElementById('new-subject-name').value; const desc = document.getElementById('new-subject-desc').value; if(!name) return showToast('Digite um nome!', 'error'); const newId = 'sub_' + Date.now(); const colors = [{ i: 'text-red-600', b: 'bg-red-100 dark:bg-red-900/30', s: 'bg-red-500', h: 'group-hover:text-red-600 dark:group-hover:text-red-400' }, { i: 'text-teal-600', b: 'bg-teal-100 dark:bg-teal-900/30', s: 'bg-teal-500', h: 'group-hover:text-teal-600 dark:group-hover:text-teal-400' }, { i: 'text-indigo-600', b: 'bg-indigo-100 dark:bg-indigo-900/30', s: 'bg-indigo-500', h: 'group-hover:text-indigo-600 dark:group-hover:text-indigo-400' }]; const randColor = colors[Math.floor(Math.random() * colors.length)]; subjects.push({ id: newId, title: name, desc: desc || 'Nova matéria', iconColor: randColor.i, bgColor: randColor.b, statusBarColor: randColor.s, hoverText: randColor.h, totalQuestions: 0, correctCount: 0, goal: 20, progress: 0, subtopics: [] }); renderGrid(); closeAddSubjectModal(); showToast('Pasta criada!', 'success'); }
        function openAddSubtopicModal() { document.getElementById('new-subtopic-name').value = ''; document.getElementById('add-subtopic-modal-overlay').classList.remove('hidden'); setTimeout(() => { document.getElementById('add-subtopic-modal-overlay').classList.remove('opacity-0'); document.getElementById('add-subtopic-modal-content').classList.remove('scale-95', 'opacity-0'); document.getElementById('add-subtopic-modal-content').classList.add('scale-100', 'opacity-100'); }, 10); }
        function closeAddSubtopicModal(event) { if (event && event.target !== document.getElementById('add-subtopic-modal-overlay')) return; document.getElementById('add-subtopic-modal-overlay').classList.add('opacity-0'); document.getElementById('add-subtopic-modal-content').classList.remove('scale-100', 'opacity-100'); document.getElementById('add-subtopic-modal-content').classList.add('scale-95', 'opacity-0'); setTimeout(() => { document.getElementById('add-subtopic-modal-overlay').classList.add('hidden'); }, 300); }
        function saveNewSubtopic() { const name = document.getElementById('new-subtopic-name').value; if(!name) return showToast('Digite um nome!', 'error'); if(!currentSubjectId) return; const sub = subjects.find(s => s.id === currentSubjectId); const newSubtopic = { id: 'st_' + Date.now(), title: name, totalQuestions: 0, correctCount: 0 }; if(!sub.subtopics) sub.subtopics = []; sub.subtopics.push(newSubtopic); closeAddSubtopicModal(); renderSubtopics(sub); updateProgressDropdown(sub); showToast('Subtópico adicionado!', 'success'); }
        function renderSubtopics(sub) { const container = document.getElementById('subtopics-list'); container.innerHTML = ''; if(!sub.subtopics || sub.subtopics.length === 0) { container.innerHTML = '<div class="text-center py-4 text-gray-400 dark:text-slate-500 text-xs italic bg-gray-50 dark:bg-slate-700/30 rounded">Nenhum subtópico criado ainda.</div>'; return; } sub.subtopics.forEach(st => { let acc = st.totalQuestions > 0 ? Math.round((st.correctCount / st.totalQuestions) * 100) : 0; let accColor = 'text-gray-400'; if (st.totalQuestions > 0) { if (acc >= 80) accColor = 'text-green-600'; else if (acc >= 60) accColor = 'text-yellow-600'; else accColor = 'text-red-500'; } const item = `<div class="bg-white dark:bg-slate-700 border border-gray-100 dark:border-slate-600 rounded p-3 flex justify-between items-center hover:border-blue-200 transition-colors"><div><span class="block font-medium text-sm text-gray-800 dark:text-white">${st.title}</span><span class="text-xs text-gray-500 dark:text-slate-400">${st.totalQuestions} questões feitas</span></div><div class="text-right"><span class="block font-bold text-sm ${accColor}">${acc}%</span><span class="text-xs text-gray-400 dark:text-slate-500">acerto</span></div></div>`; container.innerHTML += item; }); }
        function updateProgressDropdown(sub) { const select = document.getElementById('input-progress-subtopic'); select.innerHTML = '<option value="">Geral (Sem subtópico específico)</option>'; if(sub.subtopics && sub.subtopics.length > 0) { sub.subtopics.forEach(st => { const option = document.createElement('option'); option.value = st.id; option.textContent = st.title; select.appendChild(option); }); } }
        
        // --- POMODORO LOGIC REUSED ---
        function playAlarm() { if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)(); if (audioContext.state === 'suspended') audioContext.resume(); const type = document.getElementById('pomo-alarm-type').value; const now = audioContext.currentTime; const osc = audioContext.createOscillator(); const gain = audioContext.createGain(); osc.connect(gain); gain.connect(audioContext.destination); if (type === 'digital') { osc.type = 'square'; osc.frequency.setValueAtTime(800, now); osc.frequency.setValueAtTime(0, now + 0.1); osc.frequency.setValueAtTime(800, now + 0.2); osc.frequency.setValueAtTime(0, now + 0.3); gain.gain.value = 0.1; osc.start(now); osc.stop(now + 0.4); } else if (type === 'bell') { osc.type = 'sine'; osc.frequency.setValueAtTime(523.25, now); gain.gain.setValueAtTime(0.5, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 1.5); osc.start(now); osc.stop(now + 1.5); } else if (type === 'bird') { osc.type = 'triangle'; osc.frequency.setValueAtTime(1500, now); osc.frequency.linearRampToValueAtTime(2500, now + 0.1); osc.frequency.linearRampToValueAtTime(1500, now + 0.2); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.2); osc.start(now); osc.stop(now + 0.2); } else if (type === 'laser') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.3); gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3); osc.start(now); osc.stop(now + 0.3); } else if (type === 'magic') { osc.type = 'sine'; osc.frequency.setValueAtTime(523.25, now); osc.frequency.setValueAtTime(659.25, now + 0.1); osc.frequency.setValueAtTime(783.99, now + 0.2); osc.frequency.setValueAtTime(1046.50, now + 0.3); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.6); osc.start(now); osc.stop(now + 0.6); } else { osc.type = 'sine'; osc.frequency.setValueAtTime(880, now); gain.gain.setValueAtTime(0.3, now); gain.gain.linearRampToValueAtTime(0, now + 0.5); osc.start(now); osc.stop(now + 0.5); } }
        function openPomoModal() { document.getElementById('pomo-modal-overlay').classList.remove('hidden'); setTimeout(() => { document.getElementById('pomo-modal-overlay').classList.remove('opacity-0'); document.getElementById('pomo-modal-content').classList.remove('scale-95', 'opacity-0'); document.getElementById('pomo-modal-content').classList.add('scale-100', 'opacity-100'); }, 10); document.getElementById('fab-pomo').classList.add('hidden'); }
        function closePomoModal(event) { if (event && event.target !== document.getElementById('pomo-modal-overlay') && !event.target.closest('button')) return; document.getElementById('pomo-modal-overlay').classList.add('opacity-0'); document.getElementById('pomo-modal-content').classList.remove('scale-100', 'opacity-100'); document.getElementById('pomo-modal-content').classList.add('scale-95', 'opacity-0'); setTimeout(() => { document.getElementById('pomo-modal-overlay').classList.add('hidden'); document.getElementById('fab-pomo').classList.remove('hidden'); }, 300); }
        function formatPomoTime(seconds) { const m = Math.floor(seconds / 60).toString().padStart(2, '0'); const s = (seconds % 60).toString().padStart(2, '0'); return `${m}:${s}`; }
        function updatePomoDisplay() { const display = document.getElementById('pomodoro-display-modal'); if(display) { display.textContent = formatPomoTime(pomoTime); document.title = `${formatPomoTime(pomoTime)} - ${pomoMode === 'focus' ? 'Foco' : 'Pausa'}`; if (pomoMode === 'break') { display.classList.remove('text-gray-800'); display.classList.add('text-pomoBlue'); } else { display.classList.remove('text-pomoBlue'); display.classList.add('text-gray-800'); } } }
        function updatePomoUIState() { const title = document.getElementById('pomo-title-text'); const icon = document.getElementById('pomo-icon-modal'); const btn = document.getElementById('btn-pomo-main-modal'); const fab = document.getElementById('fab-pomo'); if (pomoMode === 'focus') { title.textContent = 'Pomodoro (Foco)'; icon.className = 'text-pomoRed'; btn.className = pomoRunning ? "bg-yellow-500 text-white px-6 py-2 rounded-lg hover:bg-yellow-600 transition-colors font-medium shadow-sm w-full" : "bg-pomoRed text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors font-medium shadow-sm w-full"; fab.className = "fixed bottom-6 right-6 z-40 bg-pomoRed text-white p-4 rounded-full shadow-2xl hover:scale-105 transition-all focus:outline-none focus:ring-4 focus:ring-red-300 group"; } else { title.textContent = 'Pomodoro (Descanso)'; icon.className = 'text-pomoBlue'; btn.className = pomoRunning ? "bg-yellow-500 text-white px-6 py-2 rounded-lg hover:bg-yellow-600 transition-colors font-medium shadow-sm w-full" : "bg-pomoBlue text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors font-medium shadow-sm w-full"; fab.className = "fixed bottom-6 right-6 z-40 bg-pomoBlue text-white p-4 rounded-full shadow-2xl hover:scale-105 transition-all focus:outline-none focus:ring-4 focus:ring-blue-300 group"; } btn.textContent = pomoRunning ? 'Pausar' : 'Iniciar'; }
        function updatePomoSettings() { if (!pomoRunning) { if (pomoMode === 'focus') { const focus = parseInt(document.getElementById('pomo-focus-time').value) || 25; pomoTime = focus * 60; } else { const brk = parseInt(document.getElementById('pomo-break-time').value) || 5; pomoTime = brk * 60; } updatePomoDisplay(); } }
        function setQuickTime(mins) { const inputBreak = document.getElementById('pomo-break-time'); const inputFocus = document.getElementById('pomo-focus-time'); pomoRunning = false; clearInterval(pomoInterval); if (mins === 5) { inputBreak.value = 5; pomoMode = 'break'; pomoTime = 5 * 60; } else { inputFocus.value = mins; pomoMode = 'focus'; pomoTime = mins * 60; } updatePomoDisplay(); updatePomoUIState(); document.getElementById('pomo-badge').classList.add('hidden'); }
        function resetPomodoro() { pomoRunning = false; clearInterval(pomoInterval); if (pomoMode === 'focus') { const val = parseInt(document.getElementById('pomo-focus-time').value) || 25; pomoTime = val * 60; } else { const val = parseInt(document.getElementById('pomo-break-time').value) || 5; pomoTime = val * 60; } updatePomoDisplay(); updatePomoUIState(); document.getElementById('pomo-badge').classList.add('hidden'); }
        function togglePomodoro() { if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)(); if (audioContext.state === 'suspended') audioContext.resume(); if (pomoRunning) { pomoRunning = false; clearInterval(pomoInterval); updatePomoUIState(); document.getElementById('pomo-badge').classList.add('hidden'); } else { pomoRunning = true; document.getElementById('pomo-badge').classList.remove('hidden'); updatePomoUIState(); pomoInterval = setInterval(() => { pomoTime--; if (pomoTime <= 0) { playAlarm(); if (pomoMode === 'focus') { pomoMode = 'break'; const breakMins = parseInt(document.getElementById('pomo-break-time').value) || 5; pomoTime = breakMins * 60; showToast('Foco concluído! Iniciando Pausa.', 'success'); } else { pomoMode = 'focus'; const focusMins = parseInt(document.getElementById('pomo-focus-time').value) || 25; pomoTime = focusMins * 60; showToast('Pausa concluída! Voltando ao Foco.', 'info'); } updatePomoUIState(); } updatePomoDisplay(); }, 1000); } }

        function openModal(id) {
            currentSubjectId = id; const sub = subjects.find(s => s.id === id); if(!sub) return;
            document.getElementById('ai-section').classList.add('hidden'); document.getElementById('ai-content').innerHTML = '';
            document.getElementById('modal-title').textContent = sub.title; document.getElementById('modal-desc').textContent = sub.desc;
            const iconContainer = document.getElementById('modal-icon-container'); iconContainer.className = `w-12 h-12 rounded-lg flex items-center justify-center shrink-0 ${sub.bgColor} ${sub.iconColor}`; iconContainer.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>`;
            document.getElementById('input-subject-goal').value = sub.goal; document.getElementById('input-subject-done').value = ''; document.getElementById('input-subject-correct').value = '';
            document.getElementById('weakness-result').classList.add('hidden'); document.getElementById('weakness-result').innerHTML = '';
            updateModalProgressUI(sub); renderSubtopics(sub); updateProgressDropdown(sub);
            const overlay = document.getElementById('modal-overlay'); overlay.classList.remove('hidden');
            setTimeout(() => { overlay.classList.remove('opacity-0'); document.getElementById('modal-content').classList.remove('scale-95', 'opacity-0'); document.getElementById('modal-content').classList.add('scale-100', 'opacity-100'); }, 10);
            document.body.style.overflow = 'hidden';
        }
        function closeModal(event) { if (event && event.target !== document.getElementById('modal-overlay')) return; const overlay = document.getElementById('modal-overlay'); overlay.classList.add('opacity-0'); document.getElementById('modal-content').classList.remove('scale-100', 'opacity-100'); document.getElementById('modal-content').classList.add('scale-95', 'opacity-0'); setTimeout(() => { overlay.classList.add('hidden'); document.body.style.overflow = ''; }, 300); }
        
        function updateSubjectGoal() { const val = parseInt(document.getElementById('input-subject-goal').value); if(!isNaN(val) && val > 0 && currentSubjectId) { const sub = subjects.find(s => s.id === currentSubjectId); sub.goal = val; updateModalProgressUI(sub); renderGrid(); showToast('Meta atualizada!', 'success'); } }
        function addSubjectProgress() { const done = parseInt(document.getElementById('input-subject-done').value); const correct = parseInt(document.getElementById('input-subject-correct').value); const subtopicId = document.getElementById('input-progress-subtopic').value; if (isNaN(done) || done <= 0) return showToast('Qtd. inválida.', 'error'); if (isNaN(correct) || correct < 0) return showToast('Acertos inválidos.', 'error'); if (correct > done) return showToast('Acertos > Feitas!', 'error'); if (currentSubjectId) { const sub = subjects.find(s => s.id === currentSubjectId); sub.progress += done; sub.totalQuestions += done; sub.correctCount += correct; 
        
        // Update Today specific stats (for filtering)
        if (sub.todayCorrect === undefined) sub.todayCorrect = 0;
        sub.todayCorrect += correct;

        // Update History (Log for today or update existing entry)
        const todayStr = getDateString(0);
        if (!sub.history) sub.history = [];
        const todayEntry = sub.history.find(h => h.date === todayStr);
        if(todayEntry) { todayEntry.total += done; todayEntry.correct += correct; } else { sub.history.push({ date: todayStr, total: done, correct: correct }); }

        if(subtopicId && sub.subtopics) { const st = sub.subtopics.find(t => t.id === subtopicId); if(st) { st.totalQuestions += done; st.correctCount += correct; } } document.getElementById('input-subject-done').value = ''; document.getElementById('input-subject-correct').value = ''; updateModalProgressUI(sub); renderSubtopics(sub); renderGrid(); showToast('Registrado!', 'success'); } }
        function updateModalProgressUI(sub) { const pct = sub.goal > 0 ? Math.min((sub.progress / sub.goal) * 100, 100) : 0; const remaining = Math.max(0, sub.goal - sub.progress); document.getElementById('subject-progress-text').textContent = `${sub.progress}/${sub.goal} (${Math.round(pct)}%)`; document.getElementById('subject-progress-bar').style.width = `${pct}%`; const remText = document.getElementById('subject-remaining-text'); if(remaining === 0) { remText.textContent = "Meta Batida! 🚀"; remText.className = "text-green-600 font-bold text-xs"; } else { remText.textContent = `Faltam ${remaining}`; remText.className = "text-gray-500 text-xs"; } }
        
        function openConfirmModal(msg, actionCallback) { document.getElementById('confirm-modal-msg').textContent = msg; pendingAction = actionCallback; const overlay = document.getElementById('confirm-modal-overlay'); overlay.classList.remove('hidden'); setTimeout(() => { overlay.classList.remove('opacity-0'); document.getElementById('confirm-modal-content').classList.remove('scale-95', 'opacity-0'); document.getElementById('confirm-modal-content').classList.add('scale-100', 'opacity-100'); }, 10); }
        function closeConfirmModal(event) { if (event && event.target !== document.getElementById('confirm-modal-overlay') && event.target.id !== 'confirm-modal-btn' && !event.target.closest('button')) return; if(event && event.target.id === 'confirm-modal-btn' && pendingAction) pendingAction(); const overlay = document.getElementById('confirm-modal-overlay'); overlay.classList.add('opacity-0'); document.getElementById('confirm-modal-content').classList.remove('scale-100', 'opacity-100'); document.getElementById('confirm-modal-content').classList.add('scale-95', 'opacity-0'); setTimeout(() => { overlay.classList.add('hidden'); pendingAction = null; }, 300); }
        document.getElementById('confirm-modal-btn').onclick = (e) => closeConfirmModal(e);
        function requestResetSubject() { if(!currentSubjectId) return; openConfirmModal('Tem a certeza? Isso limpa todo o progresso.', () => { const sub = subjects.find(s => s.id === currentSubjectId); if(sub) { sub.totalQuestions = 0; sub.correctCount = 0; sub.goal = 20; sub.progress = 0; if(sub.subtopics) sub.subtopics.forEach(st => { st.totalQuestions = 0; st.correctCount = 0; }); document.getElementById('input-subject-goal').value = '20'; document.getElementById('input-subject-done').value = ''; document.getElementById('input-subject-correct').value = ''; updateModalProgressUI(sub); renderSubtopics(sub); renderGrid(); showToast('Pasta zerada!', 'success'); } }); }
        function requestDeleteSubject() { if(!currentSubjectId) return; openConfirmModal('Excluir esta pasta permanentemente?', () => { const index = subjects.findIndex(s => s.id === currentSubjectId); if(index > -1) { subjects.splice(index, 1); const overlay = document.getElementById('modal-overlay'); overlay.classList.add('opacity-0'); document.getElementById('modal-content').classList.remove('scale-100', 'opacity-100'); document.getElementById('modal-content').classList.add('scale-95', 'opacity-0'); setTimeout(() => { overlay.classList.add('hidden'); document.body.style.overflow = ''; }, 300); renderGrid(); showToast('Excluída.', 'success'); } }); }

        async function callGemini(prompt) { try { const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) }); if (!response.ok) throw new Error('Falha API'); const data = await response.json(); return data.candidates[0].content.parts[0].text; } catch (error) { console.error(error); return "Erro ao conectar com Mentor IA."; } }
        async function generateAIQuestion() { const sub = subjects.find(s => s.id === currentSubjectId); const topic = sub ? sub.title : "Concursos"; const btnText = document.getElementById('btn-text-ai'); const btnLoading = document.getElementById('btn-loading-ai'); const btn = document.getElementById('btn-generate-ai'); btnText.classList.add('invisible'); btnLoading.classList.remove('hidden'); btn.disabled = true; const prompt = `Crie uma questão de concurso inédita (Difícil) sobre: "${topic}". Formato HTML limpo: <p><strong>Enunciado:</strong> ...</p><ul><li>A) ...</li>...</ul><p><strong>Gabarito:</strong> ...</p>`; const text = await callGemini(prompt); document.getElementById('ai-content').innerHTML = text; document.getElementById('ai-section').classList.remove('hidden'); btnText.classList.remove('invisible'); btnLoading.classList.add('hidden'); btn.disabled = false; }
        async function analyzeSubjectWeaknesses() { if(!currentSubjectId) return; const sub = subjects.find(s => s.id === currentSubjectId); if(!sub) return; const btn = document.getElementById('btn-analyze-weakness'); const loader = document.getElementById('loading-weakness'); const resultDiv = document.getElementById('weakness-result'); btn.disabled = true; loader.classList.remove('hidden'); resultDiv.classList.add('hidden'); let subtopicsData = "Nenhum subtópico."; if(sub.subtopics && sub.subtopics.length > 0) { subtopicsData = sub.subtopics.map(st => { let acc = st.totalQuestions > 0 ? Math.round((st.correctCount / st.totalQuestions) * 100) : 0; return `- ${st.title}: ${acc}% (${st.correctCount}/${st.totalQuestions})`; }).join('\n'); } let overallAcc = sub.totalQuestions > 0 ? Math.round((sub.correctCount / sub.totalQuestions) * 100) : 0; const prompt = `Analise desempenho: Matéria "${sub.title}" (${overallAcc}%). Subtópicos:\n${subtopicsData}. SAÍDA HTML LIMPO: <p><strong>Diagnóstico:</strong> ...</p><ul class='list-disc pl-5'><li>Ponto 1</li><li>Ponto 2</li></ul>`; try { const text = await callGemini(prompt); resultDiv.innerHTML = text; resultDiv.classList.remove('hidden'); } catch (error) { showToast('Erro IA.', 'error'); } finally { btn.disabled = false; loader.classList.add('hidden'); } }
        async function analyzePerformance() { const loading = document.getElementById('global-loading'); const modal = document.getElementById('analytics-modal'); const content = document.getElementById('analytics-content'); loading.classList.remove('hidden'); let dataSummary = subjects.map(s => { let acc = s.totalQuestions > 0 ? Math.round((s.correctCount/s.totalQuestions)*100) : 0; return `- ${s.title}: ${acc}%.`; }).join('\n'); const prompt = `Coach estudos. Dados: \n${dataSummary}. HTML LIMPO: <p><strong>Resumo:</strong> ...</p><ul><li>Dica 1</li><li>Dica 2</li></ul>`; const text = await callGemini(prompt); loading.classList.add('hidden'); content.innerHTML = text; modal.classList.remove('hidden'); }
        function closeAnalytics(event) { if (event && event.target !== document.getElementById('analytics-modal') && !event.target.closest('button')) return; document.getElementById('analytics-modal').classList.add('hidden'); }
    </script>
</body>
</html>