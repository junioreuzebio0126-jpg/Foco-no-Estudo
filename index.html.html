<!DOCTYPE html>
<html lang="pt-br" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Gerenciador de estudos e pastas de quest√µes com IA.">
    <title>Minhas Pastas | Foco no Estudo</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['Roboto', 'monospace'],
                    },
                    colors: {
                        tecBlue: '#007bc0',
                        tecBlueDark: '#005f9e',
                        tecBg: '#f3f5f7',
                        tecText: '#333333',
                        tecBorder: '#e0e0e0',
                        tecGreen: '#28a745',
                        tecGray: '#6c757d',
                        geminiPurple: '#8E24AA',
                        geminiLight: '#F3E5F5',
                        pomoRed: '#E53935',
                        pomoBlue: '#1E88E5',
                        pomoBg: '#FFEBEE',
                        darkBg: '#0f172a',
                        darkCard: '#1e293b',
                        darkBorder: '#334155'
                    },
                    boxShadow: {
                        'dashboard': '0 2px 4px rgba(0,0,0,0.05)',
                    }
                }
            }
        }
    </script>

    <style>
        body { transition: background-color 0.3s ease, color 0.3s ease; }
        .folder-card, .modal-content, header, footer { transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease; }
        .folder-card { border-radius: 6px; position: relative; overflow: hidden; }
        .status-bar { position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background-color: #e0e0e0; transition: background-color 0.2s; }
        .folder-card:hover .status-bar { background-color: #007bc0; }
        .dark .status-bar { background-color: #475569; }
        .dark .folder-card:hover .status-bar { background-color: #3b82f6; }
        #modal-overlay, #add-subject-modal-overlay, #confirm-modal-overlay, #add-subtopic-modal-overlay, #stats-modal-overlay, #pomo-modal-overlay, #teoria-modal-overlay, #analytics-modal { backdrop-filter: blur(2px); }
        .ai-response strong { font-weight: 700; color: inherit; } 
        .ai-response ul { list-style-type: disc; padding-left: 1.2rem; margin-bottom: 0.5rem; }
        .ai-response li { margin-bottom: 0.25rem; }
        .ai-response p { margin-bottom: 0.5rem; }
        .ai-response { font-family: 'Inter', sans-serif; line-height: 1.5; font-size: 0.95rem; }
        .progress-bar-bg { border-radius: 9999px; overflow: hidden; }
        .progress-bar-fill { background-color: #007bc0; height: 100%; transition: width 0.5s ease-out; }
        .dark .progress-bar-fill { background-color: #3b82f6; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast { animation: slideIn 0.3s ease-out forwards; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        @keyframes growUp { from { height: 0; } to { height: var(--h); } }
        .bar-animate { animation: growUp 1s ease-out forwards; }
    </style>
</head>
<body class="bg-[#f3f5f7] dark:bg-slate-900 text-tecText dark:text-slate-200 flex flex-col min-h-screen relative selection:bg-tecBlue selection:text-white">

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="fixed top-5 right-5 z-[70] flex flex-col gap-2 pointer-events-none"></div>

    <!-- HEADER -->
    <header class="bg-white dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 sticky top-0 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-tecBlue dark:bg-blue-600 rounded flex items-center justify-center text-white font-bold text-lg shadow-sm">F</div>
                <h1 class="text-xl font-semibold text-gray-800 dark:text-white tracking-tight">Foco no Estudo</h1>
            </div>
            
            <div class="flex items-center gap-2 md:gap-4">
                <button onclick="toggleDarkMode()" class="p-2 text-gray-500 hover:text-tecBlue dark:text-slate-400 dark:hover:text-blue-400 transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-slate-700" title="Alternar Modo Noturno">
                    <svg id="icon-sun" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="icon-moon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 block dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
                <button onclick="openTeoriaModal()" class="flex items-center gap-2 text-sm font-medium text-gray-600 dark:text-slate-300 hover:text-tecBlue dark:hover:text-blue-400 transition-colors bg-gray-50 dark:bg-slate-700 px-3 py-1.5 rounded-full border border-gray-200 dark:border-slate-600 hover:border-tecBlue dark:hover:border-blue-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>Teoria
                </button>
                <button onclick="openStatsModal()" class="flex items-center gap-2 text-sm font-medium text-gray-600 dark:text-slate-300 hover:text-tecBlue dark:hover:text-blue-400 transition-colors bg-gray-50 dark:bg-slate-700 px-3 py-1.5 rounded-full border border-gray-200 dark:border-slate-600 hover:border-tecBlue dark:hover:border-blue-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 01-2-2z" /></svg>Estat√≠sticas
                </button>
                <button onclick="analyzePerformance()" class="hidden md:flex items-center gap-2 text-sm font-medium text-geminiPurple hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300 transition-colors bg-purple-50 dark:bg-purple-900/20 px-3 py-1.5 rounded-full border border-purple-100 dark:border-purple-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>Mentor IA
                </button>
                <div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-slate-700 border-2 border-white dark:border-slate-600 shadow-sm overflow-hidden"><svg class="w-full h-full text-gray-400 dark:text-slate-500 p-1" fill="currentColor" viewBox="0 0 24 24"><path d="M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z" /></svg></div>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
            <div><h2 class="text-2xl font-bold text-gray-800 dark:text-white">Minhas Pastas</h2><p class="text-sm text-gray-500 dark:text-slate-400 mt-1">Gerencie seus cadernos, subt√≥picos e simulados IA.</p></div>
            <button onclick="openAddSubjectModal()" class="bg-tecBlue hover:bg-tecBlueDark dark:bg-blue-600 dark:hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors shadow-sm flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>Nova Mat√©ria</button>
        </div>
        <div id="folders-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </main>

    <footer class="bg-white dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700 mt-auto py-8"><div class="max-w-7xl mx-auto px-4 text-center text-sm text-gray-500 dark:text-slate-400"><p>&copy; 2024 Foco no Estudo. Todos os direitos reservados.</p></div></footer>

    <button id="fab-pomo" onclick="openPomoModal()" class="fixed bottom-6 right-6 z-40 bg-pomoRed dark:bg-red-600 text-white p-4 rounded-full shadow-2xl hover:scale-105 transition-all focus:outline-none focus:ring-4 focus:ring-red-300 dark:focus:ring-red-900 group" title="Abrir Pomodoro"><svg id="fab-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 group-hover:rotate-12 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span id="pomo-badge" class="absolute top-0 right-0 w-3 h-3 bg-green-400 border-2 border-white rounded-full hidden"></span></button>

    <!-- MODAL POMODORO -->
    <div id="pomo-modal-overlay" class="fixed inset-0 bg-gray-900/30 dark:bg-black/60 hidden z-[80] flex items-end sm:items-center justify-center sm:justify-end p-4 sm:p-6 transition-opacity duration-300 backdrop-blur-sm" onclick="closePomoModal(event)">
        <div id="pomo-modal-content" class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full sm:w-80 transform scale-95 opacity-0 transition-all duration-300 p-6 relative flex flex-col gap-4 border border-gray-100 dark:border-slate-700">
            <div class="flex justify-between items-center"><h3 class="text-lg font-bold text-gray-800 dark:text-white flex items-center gap-2"><span id="pomo-icon-modal" class="text-pomoRed dark:text-red-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg></span><span id="pomo-title-text">Pomodoro (Foco)</span></h3><button onclick="closePomoModal()" class="text-gray-400 dark:text-slate-500 hover:text-gray-600 dark:hover:text-slate-300 rounded-full p-1 hover:bg-gray-100 dark:hover:bg-slate-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div>
            <div class="bg-gray-50 dark:bg-slate-700 rounded-xl p-4 text-center border border-gray-100 dark:border-slate-600"><div class="text-5xl font-mono font-bold text-gray-800 dark:text-white tracking-wider mb-2 transition-colors duration-300" id="pomodoro-display-modal">25:00</div><div class="flex justify-center gap-2"><button id="btn-pomo-main-modal" onclick="togglePomodoro()" class="bg-pomoRed dark:bg-red-600 text-white px-6 py-2 rounded-lg hover:brightness-90 transition-all font-medium shadow-sm w-full">Iniciar</button><button onclick="resetPomodoro()" class="bg-white dark:bg-slate-600 border border-gray-300 dark:border-slate-500 text-gray-600 dark:text-slate-200 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-500 transition-colors" title="Reiniciar"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg></button></div></div>
            <div class="space-y-3"><div class="flex gap-2"><div class="flex-1"><label class="block text-xs font-semibold text-gray-500 dark:text-slate-400 mb-1">Foco (min)</label><input type="number" id="pomo-focus-time" value="25" min="1" max="120" onchange="updatePomoSettings()" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg px-3 py-1.5 text-sm text-center focus:ring-2 focus:ring-pomoRed focus:border-pomoRed outline-none"></div><div class="flex-1"><label class="block text-xs font-semibold text-gray-500 dark:text-slate-400 mb-1">Descanso (min)</label><input type="number" id="pomo-break-time" value="5" min="1" max="60" onchange="updatePomoSettings()" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg px-3 py-1.5 text-sm text-center focus:ring-2 focus:ring-pomoBlue focus:border-pomoBlue outline-none"></div></div><div><label class="block text-xs font-semibold text-gray-500 dark:text-slate-400 mb-1">Som do Alarme</label><select id="pomo-alarm-type" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg px-3 py-1.5 text-sm bg-white dark:bg-slate-700 focus:ring-2 focus:ring-pomoRed outline-none cursor-pointer"><option value="beep">Bip Simples</option><option value="digital">Rel√≥gio Digital</option><option value="bell">Sino Suave</option><option value="bird">P√°ssaro (Assobio)</option><option value="laser">Laser Futurol√≥gico</option><option value="magic">M√°gica (Sucesso)</option></select></div></div><p class="text-[10px] text-gray-400 dark:text-slate-500 text-center mt-2">O cron√¥metro alterna automaticamente entre Foco e Descanso.</p></div></div>

    <!-- MODAL TEORIA -->
    <div id="teoria-modal-overlay" class="fixed inset-0 bg-gray-900/40 dark:bg-black/60 hidden z-[75] flex items-center justify-center p-4 opacity-0 transition-opacity duration-300" onclick="closeTeoriaModal(event)"><div id="teoria-modal-content" class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl max-w-3xl w-full max-h-[85vh] transform scale-95 opacity-0 transition-all duration-300 flex flex-col relative overflow-hidden"><div class="bg-white dark:bg-slate-800 border-b border-gray-100 dark:border-slate-700 px-8 py-5 flex justify-between items-center shrink-0"><div class="flex items-center gap-3"><div class="bg-blue-50 dark:bg-slate-700 text-tecBlue dark:text-blue-400 p-2 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg></div><div><h3 class="text-xl font-bold text-gray-800 dark:text-white">Teoria</h3><p class="text-xs text-gray-500 dark:text-slate-400">Fundamentos essenciais para seus estudos.</p></div></div><button onclick="closeTeoriaModal()" class="text-gray-400 dark:text-slate-500 hover:text-gray-600 dark:hover:text-slate-300 rounded-full p-2 hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div class="p-8 overflow-y-auto bg-white dark:bg-slate-800 flex-grow text-gray-700 dark:text-slate-300"><div class="prose dark:prose-invert max-w-none"><h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">Fundamentos</h2><p class="mb-4">Esta se√ß√£o re√∫ne os principais conceitos te√≥ricos que fundamentam as estat√≠sticas apresentadas. Aqui est√£o alguns conceitos essenciais para entender os dados apresentados.</p><ul class="list-disc pl-5 space-y-3"><li><a href="#" class="text-tecBlue dark:text-blue-400 hover:underline hover:text-blue-600 transition-colors">Teoria 1 ‚Äì Conceito base</a></li><li><a href="#" class="text-tecBlue dark:text-blue-400 hover:underline hover:text-blue-600 transition-colors">Teoria 2 ‚Äì Modelo explicativo</a></li><li><a href="#" class="text-tecBlue dark:text-blue-400 hover:underline hover:text-blue-600 transition-colors">Teoria 3 ‚Äì Abordagem estat√≠stica</a></li><li><a href="#" class="text-tecBlue dark:text-blue-400 hover:underline hover:text-blue-600 transition-colors">Teoria 4 ‚Äì An√°lise de dados</a></li><li><a href="#" class="text-tecBlue dark:text-blue-400 hover:underline hover:text-blue-600 transition-colors">Teoria 5 ‚Äì Refer√™ncia complementar</a></li></ul></div></div></div></div>

    <!-- MODAL ESTAT√çSTICAS -->
    <div id="stats-modal-overlay" class="fixed inset-0 bg-gray-900/40 dark:bg-black/60 hidden z-[70] flex items-center justify-center p-4 opacity-0 transition-opacity duration-300" onclick="closeStatsModal(event)"><div id="stats-modal-content" class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl max-w-5xl w-full h-[85vh] transform scale-95 opacity-0 transition-all duration-300 flex flex-col relative overflow-hidden"><div class="bg-white dark:bg-slate-800 border-b border-gray-100 dark:border-slate-700 px-8 py-5 flex justify-between items-center shrink-0"><div class="flex items-center gap-3"><div class="bg-blue-50 dark:bg-slate-700 text-tecBlue dark:text-blue-400 p-2 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 01-2-2z" /></svg></div><div><h3 class="text-xl font-bold text-gray-800 dark:text-white">Estat√≠sticas</h3><p class="text-xs text-gray-500 dark:text-slate-400">Vis√£o geral do seu progresso.</p></div></div><div class="flex items-center gap-3"><div class="relative"><input type="date" id="stats-date-filter" onchange="renderStats()" class="border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg px-3 py-1.5 text-sm text-gray-600 focus:outline-none focus:border-tecBlue focus:ring-1 focus:ring-tecBlue shadow-sm cursor-pointer"></div><button onclick="closeStatsModal()" class="text-gray-400 dark:text-slate-500 hover:text-gray-600 dark:hover:text-slate-300 rounded-full p-2 hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div></div><div class="p-8 overflow-y-auto bg-gray-50 dark:bg-slate-900/50 flex-grow" id="stats-content"></div></div></div>

    <!-- MODAL DETALHES PASTA -->
    <div id="modal-overlay" class="fixed inset-0 bg-gray-900/40 dark:bg-black/60 hidden z-50 flex items-center justify-center p-4 opacity-0 transition-opacity duration-300" onclick="closeModal(event)">
        <div id="modal-content" class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-lg w-full transform scale-95 opacity-0 transition-all duration-300 p-0 relative overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-tecBg dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 px-6 py-4 flex justify-between items-center shrink-0">
                <h3 id="modal-title" class="text-lg font-bold text-gray-800 dark:text-white">Pasta</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-500 transition-colors p-1 rounded-full hover:bg-red-50 dark:hover:bg-slate-700" title="Fechar Janela"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="flex items-center gap-4 mb-6">
                    <div id="modal-icon-container" class="w-12 h-12 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center shrink-0"></div>
                    <div><p class="text-sm text-gray-500 dark:text-slate-400">Caderno de Quest√µes</p><p id="modal-desc" class="text-gray-800 dark:text-slate-200 font-medium">Detalhes...</p></div>
                </div>
                
                <div class="bg-blue-50 dark:bg-slate-700/50 border border-blue-100 dark:border-slate-600 rounded-lg p-4 mb-6 shadow-sm">
                    <h4 class="text-sm font-bold text-tecBlue dark:text-blue-400 mb-3 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Meta e Progresso (Total)</h4>
                    <div class="flex items-end gap-3 mb-4">
                        <div class="flex-grow"><label class="block text-xs text-gray-500 dark:text-slate-400 mb-1">Definir Meta Di√°ria (Qtd.):</label><input type="number" id="input-subject-goal" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded px-2 py-1.5 text-sm focus:outline-none focus:border-tecBlue" placeholder="Ex: 50"></div>
                        <button onclick="updateSubjectGoal()" class="bg-white dark:bg-slate-600 border border-tecBlue dark:border-blue-400 text-tecBlue dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-slate-500 px-3 py-1.5 rounded text-sm font-medium transition-colors h-[34px]">Salvar Meta</button>
                    </div>
                    <div class="border-t border-blue-200 dark:border-slate-600 pt-3">
                        <label class="block text-xs text-gray-500 dark:text-slate-400 mb-2 font-semibold">Registrar Nova Bateria (+):</label>
                        <div class="mb-2"><select id="input-progress-subtopic" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded px-2 py-1.5 text-sm focus:outline-none focus:border-tecBlue bg-white dark:bg-slate-700"><option value="">Geral (Sem subt√≥pico espec√≠fico)</option></select></div>
                        <div class="flex gap-2">
                            <div class="w-1/3"><input type="number" id="input-subject-done" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded px-2 py-1.5 text-sm focus:outline-none focus:border-tecBlue" placeholder="Feitas"></div>
                            <div class="w-1/3"><input type="number" id="input-subject-correct" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded px-2 py-1.5 text-sm focus:outline-none focus:border-green-500" placeholder="Acertos"></div>
                            <button onclick="addSubjectProgress()" class="w-1/3 bg-tecBlue hover:bg-tecBlueDark dark:bg-blue-600 dark:hover:bg-blue-700 text-white rounded text-sm font-medium transition-colors h-[34px]">Registrar</button>
                        </div>
                        <p class="text-[10px] text-gray-400 dark:text-slate-500 mt-1 pl-1">Selecione um subt√≥pico acima para categorizar.</p>
                    </div>
                    <div class="mt-4">
                        <div class="flex justify-between text-xs mb-1"><span class="text-gray-600 dark:text-slate-300 font-medium">Progresso da Meta: <span id="subject-progress-text">0/0</span></span><span class="text-gray-500 dark:text-slate-400" id="subject-remaining-text">--</span></div>
                        <div class="progress-bar-bg h-2 w-full bg-white dark:bg-slate-600"><div id="subject-progress-bar" class="progress-bar-fill bg-tecBlue dark:bg-blue-500" style="width: 0%"></div></div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3"><h4 class="text-sm font-bold text-gray-700 dark:text-slate-200 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>Subt√≥picos</h4><button onclick="openAddSubtopicModal()" class="text-xs text-tecBlue dark:text-blue-400 hover:underline font-medium">+ Novo Subt√≥pico</button></div>
                    <div id="subtopics-list" class="space-y-2"><div class="text-center py-4 text-gray-400 dark:text-slate-500 text-xs italic bg-gray-50 dark:bg-slate-700/30 rounded">Nenhum subt√≥pico criado ainda.</div></div>
                </div>
                
                <!-- AI Weakness Section -->
                <div class="bg-purple-50 dark:bg-purple-900/10 border border-purple-100 dark:border-purple-900/30 rounded-lg p-4 mb-6">
                    <h4 class="text-sm font-bold text-geminiPurple dark:text-purple-400 mb-2 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>Mentor IA: An√°lise de Defici√™ncias</h4>
                    <p class="text-xs text-gray-600 dark:text-slate-400 mb-3">A IA analisa seus subt√≥picos com baixo rendimento e sugere o que estudar.</p>
                    <button id="btn-analyze-weakness" onclick="analyzeSubjectWeaknesses()" class="w-full bg-white dark:bg-slate-700 border border-geminiPurple dark:border-purple-500 text-geminiPurple dark:text-purple-300 hover:bg-purple-100 dark:hover:bg-purple-900/50 py-2 rounded text-sm font-medium transition-colors flex items-center justify-center gap-2"><span>üîç Analisar Onde Melhorar</span><span id="loading-weakness" class="hidden"><svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></span></button>
                    <div id="weakness-result" class="mt-3 text-sm text-gray-700 dark:text-slate-300 ai-response hidden bg-white dark:bg-slate-800 p-3 rounded border border-purple-100 dark:border-purple-900 shadow-inner"></div>
                </div>
                
                <!-- AI Question Section -->
                <div id="ai-section" class="mb-6 hidden">
                    <div class="bg-purple-50 dark:bg-purple-900/10 border border-purple-100 dark:border-purple-900/30 rounded-lg p-4"><div class="flex items-center gap-2 mb-3 text-geminiPurple dark:text-purple-400 font-bold"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>Quest√£o Gerada por IA</div><div id="ai-content" class="text-sm text-gray-700 dark:text-slate-300 ai-response"></div></div>
                </div>
                
                <!-- AI Generate Button -->
                <div class="space-y-3">
                    <button id="btn-generate-ai" onclick="generateAIQuestion()" class="w-full bg-white dark:bg-slate-700 border border-geminiPurple dark:border-purple-500 text-geminiPurple dark:text-purple-300 hover:bg-purple-50 dark:hover:bg-purple-900/50 py-2.5 rounded font-medium transition-colors flex items-center justify-center gap-2 relative">
                        <span id="btn-text-ai" class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>‚ú® Gerar Quest√£o In√©dita (IA)</span>
                        <span id="btn-loading-ai" class="hidden absolute flex items-center justify-center"><svg class="animate-spin h-5 w-5 text-geminiPurple" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></span>
                    </button>
                </div>
                
                <!-- Management Buttons -->
                <div class="mt-6 pt-6 border-t border-gray-100 dark:border-slate-700">
                    <h4 class="text-xs font-bold text-gray-400 dark:text-slate-500 uppercase mb-3">Gerenciamento</h4>
                    <div class="flex gap-3">
                        <button onclick="requestResetSubject()" class="flex-1 border border-gray-300 dark:border-slate-600 text-gray-600 dark:text-slate-400 hover:bg-gray-50 dark:hover:bg-slate-700 hover:text-gray-800 dark:hover:text-slate-200 py-2.5 rounded text-sm font-medium transition-colors">Zerar Dados</button>
                        <button onclick="requestDeleteSubject()" class="flex-1 border border-red-200 dark:border-red-900/50 text-red-500 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 hover:border-red-300 py-2.5 rounded text-sm font-medium transition-colors">Excluir Pasta</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Global Modals -->
    <div id="add-subject-modal-overlay" class="fixed inset-0 bg-gray-900/40 dark:bg-black/60 hidden z-50 flex items-center justify-center p-4 opacity-0 transition-opacity duration-300" onclick="closeAddSubjectModal(event)"><div id="add-subject-modal-content" class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-md w-full transform scale-95 opacity-0 transition-all duration-300 p-0 relative overflow-hidden"><div class="bg-tecBg dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 px-6 py-4 flex justify-between items-center"><h3 class="text-lg font-bold text-gray-800 dark:text-white">Nova Mat√©ria</h3><button onclick="closeAddSubjectModal()" class="text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div class="p-6"><div class="mb-4"><label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Nome da Mat√©ria</label><input type="text" id="new-subject-name" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-tecBlue" placeholder="Ex: Direito Administrativo"></div><div class="mb-6"><label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Descri√ß√£o Curta</label><input type="text" id="new-subject-desc" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-tecBlue" placeholder="Ex: Atos Administrativos e Poderes"></div><div class="flex justify-end gap-3"><button onclick="closeAddSubjectModal()" class="px-4 py-2 text-gray-600 dark:text-slate-400 hover:bg-gray-100 dark:hover:bg-slate-700 rounded">Cancelar</button><button onclick="saveNewSubject()" class="px-4 py-2 bg-tecBlue text-white hover:bg-tecBlueDark rounded font-medium">Criar Pasta</button></div></div></div></div>
    <div id="add-subtopic-modal-overlay" class="fixed inset-0 bg-gray-900/40 dark:bg-black/60 hidden z-[55] flex items-center justify-center p-4 opacity-0 transition-opacity duration-300" onclick="closeAddSubtopicModal(event)"><div id="add-subtopic-modal-content" class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-sm w-full transform scale-95 opacity-0 transition-all duration-300 p-0 relative overflow-hidden"><div class="bg-tecBg dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 px-6 py-4 flex justify-between items-center"><h3 class="text-lg font-bold text-gray-800 dark:text-white">Novo Subt√≥pico</h3><button onclick="closeAddSubtopicModal()" class="text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div class="p-6"><div class="mb-4"><label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Nome do Subt√≥pico</label><input type="text" id="new-subtopic-name" class="w-full border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-tecBlue" placeholder="Ex: Crase, Verbos, Atos..."></div><div class="flex justify-end gap-3"><button onclick="closeAddSubtopicModal()" class="px-4 py-2 text-gray-600 dark:text-slate-400 hover:bg-gray-100 dark:hover:bg-slate-700 rounded">Cancelar</button><button onclick="saveNewSubtopic()" class="px-4 py-2 bg-tecBlue text-white hover:bg-tecBlueDark rounded font-medium">Adicionar</button></div></div></div></div>
    <div id="confirm-modal-overlay" class="fixed inset-0 bg-gray-900/40 dark:bg-black/60 hidden z-[60] flex items-center justify-center p-4 opacity-0 transition-opacity duration-300" onclick="closeConfirmModal(event)"><div id="confirm-modal-content" class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-sm w-full transform scale-95 opacity-0 transition-all duration-300 p-6 text-center"><div class="w-12 h-12 rounded-full bg-red-100 dark:bg-red-900/30 text-red-500 flex items-center justify-center mx-auto mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg></div><h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2">Tem certeza?</h3><p id="confirm-modal-msg" class="text-sm text-gray-600 dark:text-slate-400 mb-6">Esta a√ß√£o n√£o poder√° ser desfeita.</p><div class="flex gap-3 justify-center"><button onclick="closeConfirmModal()" class="px-4 py-2 border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-slate-300 rounded hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors">Cancelar</button><button id="confirm-modal-btn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors">Confirmar</button></div></div></div>
    <div id="global-loading" class="fixed inset-0 bg-white/80 dark:bg-slate-900/80 z-[60] hidden flex flex-col items-center justify-center"><svg class="animate-spin h-10 w-10 text-geminiPurple mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="text-geminiPurple font-medium animate-pulse">Analisando dados...</p></div>
    
    <!-- ANALYTICS AI MODAL -->
    <div id="analytics-modal" class="fixed inset-0 bg-gray-900/40 dark:bg-black/60 hidden z-50 flex items-center justify-center p-4" onclick="closeAnalytics(event)">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-2xl w-full p-6 relative">
            <button onclick="closeAnalytics()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            <h3 class="text-xl font-bold text-geminiPurple dark:text-purple-400 mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                An√°lise do Mentor IA
            </h3>
            <div id="analytics-content" class="prose prose-sm max-w-none text-gray-700 dark:text-slate-300 ai-response bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg border border-purple-100 dark:border-purple-800 h-96 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        const apiKey = ""; 

        // --- CORE IA ENGINE (GEMINI) ---
        async function callGemini(prompt, systemInstruction = "") {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: systemInstruction ? { parts: [{ text: systemInstruction }] } : { parts: [{ text: "Voc√™ √© um Mentor de Estudos para Concursos especialista em alta performance e an√°lise de dados estat√≠sticos." }] }
            };

            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        const result = await response.json();
                        return result.candidates?.[0]?.content?.parts?.[0]?.text || "Ocorreu um erro ao processar a resposta.";
                    }
                } catch (error) {
                    // Silently fail for individual retries
                }
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2;
            }
            throw new Error("N√£o foi poss√≠vel conectar com o Mentor IA. Verifique sua conex√£o.");
        }

        // --- THEME ENGINE ---
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            renderGrid();
            if (!document.getElementById('stats-modal-overlay').classList.contains('hidden')) renderStats();
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        }
        
        function getDateString(daysOffset = 0) {
            const d = new Date();
            d.setDate(d.getDate() - daysOffset);
            return d.toISOString().split('T')[0];
        }

        // --- DATA STATE ---
        let subjects = [
            { id: 'sub_1', title: 'Direito Constitucional', iconColor: 'text-blue-600 dark:text-blue-400', bgColor: 'bg-blue-100 dark:bg-blue-900/30', statusBarColor: 'bg-blue-500', hoverText: 'group-hover:text-tecBlue dark:group-hover:text-blue-400', totalQuestions: 1240, correctCount: 967, goal: 50, progress: 15, todayCorrect: 12, subtopics: [], history: [{ date: getDateString(1), total: 40, correct: 35 }, { date: getDateString(2), total: 20, correct: 15 }, { date: getDateString(5), total: 60, correct: 50 }] },
            { id: 'sub_2', title: 'Portugu√™s - FGV', iconColor: 'text-orange-600 dark:text-orange-400', bgColor: 'bg-orange-100 dark:bg-orange-900/30', statusBarColor: 'bg-orange-500', hoverText: 'group-hover:text-orange-600 dark:group-hover:text-orange-400', totalQuestions: 850, correctCount: 527, goal: 30, progress: 0, todayCorrect: 0, subtopics: [{ id: 'st_1', title: 'Interpreta√ß√£o', totalQuestions: 500, correctCount: 300 }, { id: 'st_2', title: 'Crase', totalQuestions: 350, correctCount: 227 }], history: [{ date: getDateString(1), total: 30, correct: 15 }, { date: getDateString(3), total: 25, correct: 20 }] },
            { id: 'sub_3', title: 'Racioc√≠nio L√≥gico', iconColor: 'text-purple-600 dark:text-purple-400', bgColor: 'bg-purple-100 dark:bg-purple-900/30', statusBarColor: 'bg-purple-500', hoverText: 'group-hover:text-purple-600 dark:group-hover:text-purple-400', totalQuestions: 230, correctCount: 0, goal: 20, progress: 5, todayCorrect: 2, subtopics: [], history: [] }
        ];

        let currentSubjectId = null;
        let pendingAction = null;
        let pomoTime = 25 * 60; 
        let pomoInterval = null;
        let pomoRunning = false;
        let pomoMode = 'focus'; 
        let audioContext = null;

        document.addEventListener('DOMContentLoaded', () => { 
            initTheme();
            renderGrid(); 
            document.getElementById('stats-date-filter').value = getDateString(0);
        });

        // --- IA FEATURES ---
        async function analyzePerformance() {
            const loading = document.getElementById('global-loading');
            const modal = document.getElementById('analytics-modal');
            const content = document.getElementById('analytics-content');
            
            if (!loading || !modal || !content) return;

            loading.classList.remove('hidden');
            
            let dataSummary = subjects.map(s => {
                let acc = s.totalQuestions > 0 ? Math.round((s.correctCount/s.totalQuestions)*100) : 0;
                return `- ${s.title}: ${acc}% (${s.correctCount}/${s.totalQuestions}). Meta: ${s.progress}/${s.goal}.`;
            }).join('\n');

            const prompt = `Analise globalmente meu desempenho nas seguintes mat√©rias:\n${dataSummary}\n\nFormato da resposta: Use HTML simples (p, strong, ul, li). Forne√ßa um diagn√≥stico r√°pido, elogie pontos fortes e d√™ 3 dicas pr√°ticas de estudo para melhorar as mat√©rias fracas.`;

            try {
                const text = await callGemini(prompt);
                content.innerHTML = text;
                loading.classList.add('hidden');
                modal.classList.remove('hidden');
            } catch (error) {
                loading.classList.add('hidden');
                showToast(error.message, 'error');
            }
        }

        async function analyzeSubjectWeaknesses() {
            if(!currentSubjectId) return;
            const sub = subjects.find(s => s.id === currentSubjectId);
            if(!sub) return;

            const btn = document.getElementById('btn-analyze-weakness');
            const loader = document.getElementById('loading-weakness');
            const resultDiv = document.getElementById('weakness-result');

            if (!btn || !loader || !resultDiv) return;

            btn.disabled = true;
            loader.classList.remove('hidden');
            resultDiv.classList.add('hidden');

            let subtopicsData = "Sem subt√≥picos registrados.";
            if(sub.subtopics && sub.subtopics.length > 0) {
                subtopicsData = sub.subtopics.map(st => {
                    let acc = st.totalQuestions > 0 ? Math.round((st.correctCount / st.totalQuestions) * 100) : 0;
                    return `- ${st.title}: ${acc}% de acerto (${st.correctCount}/${st.totalQuestions})`;
                }).join('\n');
            }

            const overallAcc = sub.totalQuestions > 0 ? Math.round((sub.correctCount / sub.totalQuestions) * 100) : 0;
            const prompt = `Analise as defici√™ncias na mat√©ria "${sub.title}" (Geral: ${overallAcc}%). Subt√≥picos:\n${subtopicsData}.\n\nSA√çDA HTML LIMPO: Use <p> e <ul>. Diga quais assuntos requerem mais teoria e quais requerem apenas mais pr√°tica. Seja direto.`;

            try {
                const text = await callGemini(prompt);
                resultDiv.innerHTML = text;
                resultDiv.classList.remove('hidden');
            } catch (error) {
                showToast("Erro na IA: " + error.message, 'error');
            } finally {
                btn.disabled = false;
                loader.classList.add('hidden');
            }
        }

        async function generateAIQuestion() {
            const sub = subjects.find(s => s.id === currentSubjectId);
            if (!sub) return;

            const btnText = document.getElementById('btn-text-ai');
            const btnLoading = document.getElementById('btn-loading-ai');
            const btn = document.getElementById('btn-generate-ai');
            const aiSection = document.getElementById('ai-section');
            const aiContent = document.getElementById('ai-content');

            btnText.classList.add('invisible');
            btnLoading.classList.remove('hidden');
            btn.disabled = true;

            const prompt = `Crie uma quest√£o de concurso in√©dita e dif√≠cil sobre: "${sub.title}".\nFormato HTML: <p><strong>Enunciado:</strong> ...</p><ul><li>A) ...</li><li>B) ...</li><li>C) ...</li><li>D) ...</li><li>E) ...</li></ul><p class="mt-2"><strong>Gabarito Comentado:</strong> ...</p>`;

            try {
                const text = await callGemini(prompt);
                aiContent.innerHTML = text;
                aiSection.classList.remove('hidden');
            } catch (error) {
                showToast("Falha ao gerar quest√£o.", 'error');
            } finally {
                btnText.classList.remove('invisible');
                btnLoading.classList.add('hidden');
                btn.disabled = false;
            }
        }

        // --- INTERFACE CONTROL ---
        function openTeoriaModal() { const m = document.getElementById('teoria-modal-overlay'); m.classList.remove('hidden'); setTimeout(() => { m.classList.remove('opacity-0'); m.children[0].classList.remove('scale-95', 'opacity-0'); m.children[0].classList.add('scale-100', 'opacity-100'); }, 10); }
        function closeTeoriaModal() { const m = document.getElementById('teoria-modal-overlay'); m.classList.add('opacity-0'); m.children[0].classList.add('scale-95', 'opacity-0'); setTimeout(() => m.classList.add('hidden'), 300); }
        function openStatsModal() { document.getElementById('stats-date-filter').value = getDateString(0); renderStats(); const m = document.getElementById('stats-modal-overlay'); m.classList.remove('hidden'); setTimeout(() => { m.classList.remove('opacity-0'); m.children[0].classList.remove('scale-95', 'opacity-0'); m.children[0].classList.add('scale-100', 'opacity-100'); }, 10); }
        function closeStatsModal() { const m = document.getElementById('stats-modal-overlay'); m.classList.add('opacity-0'); m.children[0].classList.add('scale-95', 'opacity-0'); setTimeout(() => m.classList.add('hidden'), 300); }
        function closeAnalytics() { document.getElementById('analytics-modal').classList.add('hidden'); }
        function openModal(id) {
            currentSubjectId = id; const sub = subjects.find(s => s.id === id); if(!sub) return;
            document.getElementById('ai-section').classList.add('hidden'); 
            document.getElementById('modal-title').textContent = sub.title; document.getElementById('modal-desc').textContent = sub.desc || "Caderno de quest√µes";
            const iconC = document.getElementById('modal-icon-container'); iconC.className = `w-12 h-12 rounded-lg flex items-center justify-center shrink-0 ${sub.bgColor} ${sub.iconColor}`;
            document.getElementById('input-subject-goal').value = sub.goal;
            document.getElementById('weakness-result').classList.add('hidden');
            updateModalProgressUI(sub); renderSubtopics(sub); updateProgressDropdown(sub);
            const m = document.getElementById('modal-overlay'); m.classList.remove('hidden');
            setTimeout(() => { m.classList.remove('opacity-0'); m.children[0].classList.remove('scale-95', 'opacity-0'); m.children[0].classList.add('scale-100', 'opacity-100'); }, 10);
        }
        function closeModal() { const m = document.getElementById('modal-overlay'); m.classList.add('opacity-0'); m.children[0].classList.add('scale-95', 'opacity-0'); setTimeout(() => m.classList.add('hidden'), 300); }

        // --- STATS ENGINE ---
        function renderStats() {
            const container = document.getElementById('stats-content');
            const selectedDate = document.getElementById('stats-date-filter').value;
            const todayStr = getDateString(0);
            let totalQ = 0, totalC = 0, todayQ = 0;
            
            let filtered = subjects.map(s => {
                let q = 0, c = 0;
                if (selectedDate === todayStr) { q = s.progress; c = s.todayCorrect || 0; }
                else { const entry = s.history?.find(h => h.date === selectedDate); if(entry) { q = entry.total; c = entry.correct; } }
                return { ...s, statQ: q, statC: c };
            });

            filtered.forEach(s => { totalQ += s.statQ; totalC += s.statC; if(selectedDate === todayStr) todayQ += s.progress; });
            let acc = totalQ > 0 ? Math.round((totalC / totalQ) * 100) : 0;
            
            if (totalQ === 0 && selectedDate !== todayStr) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-gray-400">Sem dados para esta data.</div>`;
                return;
            }

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-center">
                    <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border dark:border-slate-600 shadow-sm">
                        <p class="text-xs text-gray-500 uppercase font-bold">Realizadas</p><p class="text-4xl font-bold text-tecBlue">${totalQ}</p>
                    </div>
                    <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border dark:border-slate-600 shadow-sm">
                        <p class="text-xs text-gray-500 uppercase font-bold">Acertos</p><p class="text-4xl font-bold text-green-500">${totalC}</p>
                    </div>
                    <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border dark:border-slate-600 shadow-sm">
                        <p class="text-xs text-gray-500 uppercase font-bold">Precis√£o</p><p class="text-4xl font-bold text-orange-500">${acc}%</p>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-700 p-6 rounded-2xl border dark:border-slate-600 shadow-sm">
                    <h4 class="font-bold mb-6">Desempenho por Mat√©ria</h4>
                    <div class="space-y-6">
                        ${filtered.filter(s => s.statQ > 0).map(s => {
                            let sAcc = Math.round((s.statC / s.statQ) * 100);
                            return `
                            <div>
                                <div class="flex justify-between text-sm mb-1"><span>${s.title}</span><span class="font-bold">${sAcc}%</span></div>
                                <div class="w-full h-3 bg-gray-100 dark:bg-slate-600 rounded-full overflow-hidden flex">
                                    <div class="bg-green-500 h-full" style="width: ${sAcc}%"></div>
                                    <div class="bg-red-500 h-full" style="width: ${100 - sAcc}%"></div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
        }

        // --- HELPERS ---
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            let bg = type === 'error' ? 'bg-red-600' : (type === 'success' ? 'bg-green-600' : 'bg-gray-800');
            toast.className = `toast ${bg} text-white text-sm px-4 py-2 rounded shadow-lg flex items-center gap-2 pointer-events-auto`;
            toast.innerHTML = `<span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function renderGrid() {
            const grid = document.getElementById('folders-grid'); grid.innerHTML = '';
            subjects.forEach(sub => {
                const pct = sub.goal > 0 ? Math.min((sub.progress / sub.goal) * 100, 100) : 0;
                let acc = sub.totalQuestions > 0 ? Math.round((sub.correctCount / sub.totalQuestions) * 100) : '--';
                let accColor = acc >= 80 ? 'text-green-500' : (acc >= 60 ? 'text-yellow-500' : 'text-red-500');
                grid.innerHTML += `
                <div onclick="openModal('${sub.id}')" class="group relative bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-slate-700 shadow-sm hover:shadow-md transition-all cursor-pointer overflow-hidden flex flex-col">
                    <div class="absolute left-0 top-0 bottom-0 w-1 ${sub.statusBarColor}"></div>
                    <button onclick="deleteFolderFromCard(event, '${sub.id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition-all"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                    <div class="p-4 pl-5">
                        <div class="flex items-start gap-3 mb-3">
                            <div class="${sub.iconColor}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg></div>
                            <div class="flex-1 min-w-0"><h3 class="font-semibold text-base truncate dark:text-white">${sub.title}</h3></div>
                        </div>
                        <div class="grid grid-cols-4 gap-2 border-t dark:border-slate-700 pt-3">
                            <div class="flex flex-col"><span class="text-[9px] uppercase text-gray-400">Total</span><span class="text-xs font-bold">${sub.totalQuestions}</span></div>
                            <div class="flex flex-col"><span class="text-[9px] uppercase text-gray-400">Acertos</span><span class="text-xs font-bold text-green-500">${sub.correctCount}</span></div>
                            <div class="flex flex-col"><span class="text-[9px] uppercase text-gray-400">Erros</span><span class="text-xs font-bold text-red-500">${sub.totalQuestions - sub.correctCount}</span></div>
                            <div class="flex flex-col text-right"><span class="text-[9px] uppercase text-gray-400">Aprov.</span><span class="text-xs font-bold ${accColor}">${acc}%</span></div>
                        </div>
                    </div>
                    <div class="bg-gray-50 dark:bg-slate-700/30 px-4 py-2 flex items-center justify-between border-t dark:border-slate-700">
                        <span class="text-[10px] text-gray-400 uppercase">Meta Di√°ria</span>
                        <div class="flex items-center gap-2 w-1/2 justify-end">
                            <span class="text-[10px] font-bold">${sub.progress}/${sub.goal}</span>
                            <div class="w-16 h-1.5 bg-gray-200 dark:bg-slate-600 rounded-full overflow-hidden"><div class="h-full ${pct >= 100 ? 'bg-green-500' : sub.statusBarColor}" style="width: ${pct}%"></div></div>
                        </div>
                    </div>
                </div>`;
            });
        }

        // --- SHARED MODAL LOGIC ---
        function deleteFolderFromCard(e, id) { e.stopPropagation(); currentSubjectId = id; requestDeleteSubject(); }
        function openAddSubjectModal() { document.getElementById('add-subject-modal-overlay').classList.remove('hidden'); setTimeout(() => document.getElementById('add-subject-modal-overlay').classList.remove('opacity-0'), 10); }
        function closeAddSubjectModal() { document.getElementById('add-subject-modal-overlay').classList.add('opacity-0'); setTimeout(() => document.getElementById('add-subject-modal-overlay').classList.add('hidden'), 300); }
        function saveNewSubject() { const n = document.getElementById('new-subject-name').value; if(!n) return showToast('Nome vazio!', 'error'); const colors = [{i:'text-blue-500',b:'bg-blue-100',s:'bg-blue-500'},{i:'text-green-500',b:'bg-green-100',s:'bg-green-500'}]; const c = colors[Math.floor(Math.random()*colors.length)]; subjects.push({id:'sub_'+Date.now(),title:n,iconColor:c.i,bgColor:c.b,statusBarColor:c.s,totalQuestions:0,correctCount:0,goal:20,progress:0,subtopics:[]}); renderGrid(); closeAddSubjectModal(); showToast('Pasta criada!', 'success'); }
        function openAddSubtopicModal() { document.getElementById('add-subtopic-modal-overlay').classList.remove('hidden'); setTimeout(() => document.getElementById('add-subtopic-modal-overlay').classList.remove('opacity-0'), 10); }
        function closeAddSubtopicModal() { document.getElementById('add-subtopic-modal-overlay').classList.add('opacity-0'); setTimeout(() => document.getElementById('add-subtopic-modal-overlay').classList.add('hidden'), 300); }
        function saveNewSubtopic() { const n = document.getElementById('new-subtopic-name').value; if(!n) return; const sub = subjects.find(s => s.id === currentSubjectId); sub.subtopics.push({id:'st_'+Date.now(),title:n,totalQuestions:0,correctCount:0}); renderSubtopics(sub); updateProgressDropdown(sub); closeAddSubtopicModal(); }
        function renderSubtopics(sub) { const c = document.getElementById('subtopics-list'); c.innerHTML = sub.subtopics.length ? sub.subtopics.map(st => `<div class="bg-white dark:bg-slate-700 p-3 rounded border dark:border-slate-600 flex justify-between"><span>${st.title}</span><span class="font-bold text-tecBlue">${st.totalQuestions} Q</span></div>`).join('') : '<p class="text-center text-gray-400 text-xs">Vazio</p>'; }
        function updateProgressDropdown(sub) { const s = document.getElementById('input-progress-subtopic'); s.innerHTML = '<option value="">Geral</option>' + sub.subtopics.map(st => `<option value="${st.id}">${st.title}</option>`).join(''); }
        function updateModalProgressUI(sub) { const pct = sub.goal > 0 ? Math.min((sub.progress / sub.goal) * 100, 100) : 0; document.getElementById('subject-progress-text').textContent = `${sub.progress}/${sub.goal} (${Math.round(pct)}%)`; document.getElementById('subject-progress-bar').style.width = pct + '%'; }
        function addSubjectProgress() { 
            const d = parseInt(document.getElementById('input-subject-done').value), c = parseInt(document.getElementById('input-subject-correct').value); 
            if(isNaN(d) || d<=0 || isNaN(c) || c>d) return showToast('Dados inv√°lidos', 'error');
            const sub = subjects.find(s => s.id === currentSubjectId);
            sub.progress += d; sub.totalQuestions += d; sub.correctCount += c; sub.todayCorrect = (sub.todayCorrect || 0) + c;
            const t = getDateString(0); let entry = sub.history.find(h => h.date === t);
            if(entry) { entry.total += d; entry.correct += c; } else { sub.history.push({date:t, total:d, correct:c}); }
            updateModalProgressUI(sub); renderGrid(); showToast('Salvo!', 'success');
        }
        function requestResetSubject() { const sub = subjects.find(s => s.id === currentSubjectId); sub.progress = sub.totalQuestions = sub.correctCount = 0; sub.history = []; renderGrid(); updateModalProgressUI(sub); showToast('Zerado'); }
        function requestDeleteSubject() { subjects = subjects.filter(s => s.id !== currentSubjectId); renderGrid(); closeModal(); showToast('Exclu√≠do'); }
        function updateSubjectGoal() { const g = parseInt(document.getElementById('input-subject-goal').value); if(!isNaN(g) && g > 0) { subjects.find(s => s.id === currentSubjectId).goal = g; renderGrid(); showToast('Meta salva'); } }
        
        // --- POMODORO ENGINE ---
        function togglePomodoro() {
            if(!pomoRunning) { pomoRunning = true; pomoInterval = setInterval(() => { pomoTime--; if(pomoTime<=0) { playAlarm(); pomoMode = pomoMode==='focus'?'break':'focus'; pomoTime = (pomoMode==='focus'?25:5)*60; } updatePomoDisplay(); }, 1000); }
            else { pomoRunning = false; clearInterval(pomoInterval); }
            updatePomoUIState();
        }
        function resetPomodoro() { pomoRunning = false; clearInterval(pomoInterval); pomoTime = 25*60; updatePomoDisplay(); updatePomoUIState(); }
        function updatePomoDisplay() { const m = Math.floor(pomoTime/60), s = pomoTime%60; document.getElementById('pomodoro-display-modal').textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; }
        function updatePomoUIState() { document.getElementById('btn-pomo-main-modal').textContent = pomoRunning ? 'Pausar' : 'Iniciar'; }
        function updatePomoSettings() { const f = parseInt(document.getElementById('pomo-focus-time').value); if(!pomoRunning) pomoTime = f*60; updatePomoDisplay(); }
        function openPomoModal() { document.getElementById('pomo-modal-overlay').classList.remove('hidden'); }
        function closePomoModal() { document.getElementById('pomo-modal-overlay').classList.add('hidden'); }
    </script>
</body>
</html>
